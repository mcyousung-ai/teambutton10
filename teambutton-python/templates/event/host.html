{% extends "base.html" %}
{% block nav %}{% endblock %}
{% block title %}í˜¸ìŠ¤íŠ¸ - {{ event.title }}{% endblock %}
{% block extra_css %}
<style>
body{background:var(--bg);overflow:hidden}
.host-wrap{display:flex;height:100vh}
/* Left Sidebar - Feature buttons */
.host-left{width:72px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;padding:8px 0}
.host-left .logo{padding:10px;text-align:center;border-bottom:1px solid var(--border);margin-bottom:4px}
.host-left .logo img{width:32px;height:32px;border-radius:8px}
.feat-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 4px;cursor:pointer;transition:all .2s;border:none;background:none;width:100%;gap:2px;border-left:3px solid transparent}
.feat-btn:hover{background:var(--indigo-50)}
.feat-btn.active{background:var(--indigo-50);border-left-color:var(--point-500)}
.feat-btn i{font-size:18px;color:var(--text2)}
.feat-btn.active i{color:var(--point-500)}
.feat-btn span{font-size:9px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60px}
.feat-btn.active span{color:var(--point-600);font-weight:600}
.feat-sep{height:1px;background:var(--border);margin:4px 8px}
/* Main Content */
.host-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
/* Top bar */
.host-top{background:var(--bg2);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.host-top .info{display:flex;align-items:center;gap:10px}
.host-top .info h3{font-size:15px;font-weight:700}
.host-top .code{font-size:20px;font-weight:800;color:var(--point-500);letter-spacing:1px}
.host-top .actions{display:flex;align-items:center;gap:6px}
/* Progress bar */
.host-progress{height:4px;background:var(--bg3);flex-shrink:0}
.host-progress .fill{height:100%;background:linear-gradient(90deg,var(--point-400),var(--point-600));transition:width .5s}
/* Feature Content */
.host-content{flex:1;overflow-y:auto;padding:20px}
.feature-content{max-width:900px;margin:0 auto}
/* Right sidebar - Responses */
.host-right{width:300px;background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.host-right .tabs{flex-shrink:0}
.resp-list{flex:1;overflow-y:auto;padding:8px}
.resp-item{padding:8px 10px;border-bottom:1px solid var(--bg3);font-size:13px;display:flex;justify-content:space-between;align-items:center;animation:msgIn .2s ease}
.resp-item .name{font-weight:600;color:var(--text)}
.resp-item .answer{color:var(--text2);max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.resp-count{padding:8px 12px;background:var(--bg3);font-size:12px;font-weight:600;color:var(--text2);text-align:center;border-bottom:1px solid var(--border)}
/* Game form styles */
.game-form{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:var(--shadow-card)}
.game-form h3{font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.game-form .subtitle{font-size:12px;color:var(--text3);margin-bottom:16px}
.game-actions{display:flex;gap:8px;margin-top:16px}
/* Status header */
.status-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;margin-bottom:16px}
.status-header .left{display:flex;align-items:center;gap:8px}
.status-header .right{display:flex;gap:6px}
/* Participant table in host */
.p-table{width:100%;font-size:12px}
.p-table th{padding:8px 10px;background:var(--bg3);font-weight:600;color:var(--text2);text-align:left;border-bottom:1px solid var(--border)}
.p-table td{padding:8px 10px;border-bottom:1px solid var(--bg3)}
.p-table tr:hover{background:var(--indigo-50)}
/* Score input */
.score-input{width:60px;padding:4px 6px;font-size:12px;text-align:center;border-radius:8px}
/* Chat in host */
.host-chat{flex:1;display:flex;flex-direction:column}
.host-chat .msgs{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:4px}
/* Leaderboard in response */
.lb-item{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-bottom:1px solid var(--bg3);font-size:12px}
.lb-item .rank{width:24px;font-weight:700;color:var(--text3)}
.lb-item .clicks{font-weight:800;color:var(--point-500);font-variant-numeric:tabular-nums}
/* Code number display */
.cn-display{font-size:80px;font-weight:900;text-align:center;color:var(--point-500);margin:16px 0;line-height:1}
/* Lottery result */
.lottery-result{text-align:center;padding:24px;font-size:28px;font-weight:800;color:var(--point-600)}
/* Mobile */
@media(max-width:900px){
.host-right{display:none}
.host-left{width:56px}
.feat-btn span{display:none}
.feat-btn{padding:10px 4px}
}
</style>
{% endblock %}
{% block content %}
<div class="host-wrap">
<!-- Left Sidebar: Feature Buttons -->
<div class="host-left">
<div class="logo"><img src="/static/images/logo.png" alt="TB" onerror="this.textContent='TB'"></div>
<button class="feat-btn active" data-feat="preparing" onclick="switchFeat(this,'preparing')"><i class="ri-home-4-line"></i><span>ì¤€ë¹„</span></button>
<button class="feat-btn" data-feat="management" onclick="switchFeat(this,'management')"><i class="ri-group-line"></i><span>íŒ€/ê°œì¸</span></button>
<button class="feat-btn" data-feat="score" onclick="switchFeat(this,'score')"><i class="ri-trophy-line"></i><span>ì ìˆ˜</span></button>
<button class="feat-btn" data-feat="chat" onclick="switchFeat(this,'chat')"><i class="ri-chat-3-line"></i><span>ì±„íŒ…</span></button>
<div class="feat-sep"></div>
<button class="feat-btn" data-feat="quiz_multiple" onclick="switchFeat(this,'quiz_multiple')"><i class="ri-checkbox-multiple-line"></i><span>ê°ê´€ì‹</span></button>
<button class="feat-btn" data-feat="quiz_subjective" onclick="switchFeat(this,'quiz_subjective')"><i class="ri-pencil-line"></i><span>ì£¼ê´€ì‹</span></button>
<button class="feat-btn" data-feat="quiz_order" onclick="switchFeat(this,'quiz_order')"><i class="ri-sort-number-asc"></i><span>ìˆœì„œ</span></button>
<button class="feat-btn" data-feat="buzzer" onclick="switchFeat(this,'buzzer')"><i class="ri-alarm-warning-line"></i><span>ë¶€ì €</span></button>
<button class="feat-btn" data-feat="buzzer_count" onclick="switchFeat(this,'buzzer_count')"><i class="ri-speed-line"></i><span>ë¶€ì €ì¹´ìš´íŠ¸</span></button>
<button class="feat-btn" data-feat="code_number" onclick="switchFeat(this,'code_number')"><i class="ri-grid-line"></i><span>ì½”ë“œë„˜ë²„</span></button>
<button class="feat-btn" data-feat="bingo" onclick="switchFeat(this,'bingo')"><i class="ri-layout-grid-line"></i><span>ë¹™ê³ </span></button>
<div class="feat-sep"></div>
<button class="feat-btn" data-feat="timer" onclick="switchFeat(this,'timer')"><i class="ri-timer-line"></i><span>íƒ€ì´ë¨¸</span></button>
<button class="feat-btn" data-feat="lottery" onclick="switchFeat(this,'lottery')"><i class="ri-gift-line"></i><span>ì¶”ì²¨</span></button>
<button class="feat-btn" data-feat="like" onclick="switchFeat(this,'like')"><i class="ri-heart-line"></i><span>ì¢‹ì•„ìš”</span></button>
<div class="feat-sep"></div>
<button class="feat-btn" data-feat="settings" onclick="switchFeat(this,'settings')"><i class="ri-settings-3-line"></i><span>ì„¤ì •</span></button>
</div>

<!-- Main Area -->
<div class="host-main">
<div class="host-top">
<div class="info">
<h3>{{ event.title }}</h3>
<span class="badge badge-gray badge-dot" id="evBadge">{{ event.status }}</span>
<span style="font-size:12px;color:var(--text3)"><i class="ri-group-line"></i> <span id="pCnt">{{ participants|length }}</span>ëª…</span>
</div>
<div class="flex items-center gap-3">
<span class="code">{{ event.code }}</span>
<div class="actions">
<button class="btn btn-sm btn-success" onclick="startEvent()"><i class="ri-play-fill"></i> ì‹œì‘</button>
<button class="btn btn-sm btn-danger" onclick="endEvent()"><i class="ri-stop-fill"></i> ì¢…ë£Œ</button>
</div>
</div>
</div>
<div class="host-progress"><div class="fill" id="progFill" style="width:0%"></div></div>
<div class="host-content"><div class="feature-content" id="featureArea"></div></div>
</div>

<!-- Right Sidebar: Responses + Chat -->
<div class="host-right">
<div class="tabs"><div class="tab active" onclick="switchRightTab(this,'resp')">ì‘ë‹µ</div><div class="tab" onclick="switchRightTab(this,'hchat')">ì±„íŒ…</div></div>
<div id="rtResp" style="flex:1;display:flex;flex-direction:column">
<div class="resp-count" id="respCount">ì‘ë‹µ 0ëª…</div>
<div class="resp-list" id="respList"></div>
</div>
<div id="rtChat" class="host-chat" style="display:none">
<div class="msgs" id="hChatMsgs"></div>
<div class="chat-input"><input type="text" id="hChatIn" placeholder="ë©”ì‹œì§€..." onkeypress="if(event.key==='Enter')hSendChat()"><button class="btn btn-sm btn-primary" onclick="hSendChat()">ì „ì†¡</button></div>
</div>
</div>
</div>

<script>
const E={{ event.id }},TEAMS={{ teams|tojson }};
let P={{ participants|tojson }},GID=null,GT=null,curFeat='preparing',responses=[];
const S=io();S.emit('host:join',{eventId:E});

// === Socket Listeners ===
S.on('event:started',()=>{$('evBadge').textContent='ì§„í–‰ì¤‘';$('evBadge').className='badge badge-success badge-dot';showToast('ì´ë²¤íŠ¸ ì‹œì‘!')});
S.on('event:ended',()=>{$('evBadge').textContent='ì¢…ë£Œ';$('evBadge').className='badge badge-danger badge-dot'});
S.on('participants:updated',d=>{P=d.participants;$('pCnt').textContent=P.length;if(curFeat==='management'||curFeat==='score')renderFeat()});
S.on('teams:updated',d=>{});
S.on('chat:message',d=>addHChat(d));
S.on('game:prepared',d=>{GID=d.gameId;showToast(GT+' ê²Œì„ ì¤€ë¹„ ì™„ë£Œ');renderFeat()});
S.on('timer:prepared',d=>{GID=d.timerId;showToast('íƒ€ì´ë¨¸ ì¤€ë¹„ ì™„ë£Œ');renderFeat()});
S.on('game:started',d=>{showToast('ê²Œì„ ì‹œì‘!');responses=[]});
S.on('game:ended',d=>{showToast('ê²Œì„ ì¢…ë£Œ')});
S.on('game:response',d=>{addResponse(d)});
S.on('game:buzzer_count_click',d=>{updateBCResponse(d)});
S.on('game:buzzer_count_winner',d=>{showToast('ğŸ† ìš°ìŠ¹: '+d.winner?.name)});
S.on('game:code_number_next',d=>{if(curFeat==='code_number'){const el=$('cnNum');if(el)el.textContent=d.number===0?'ğŸƒ':d.number}});
S.on('game:lottery_result',d=>{const el=$('lotteryRes');if(el)el.innerHTML='ğŸ‰ '+d.winners.join(', ')+'<div style="font-size:14px;color:var(--text3);margin-top:8px">ì „ì²´ ë‹¹ì²¨: '+d.allWinners.join(', ')+'</div>'});
S.on('timer:tick',d=>{const el=$('timerDisp');if(el){const m=Math.floor(d.remaining/60),s=d.remaining%60;el.textContent=m+':'+String(s).padStart(2,'0');if(d.remaining<=10)el.style.color='var(--danger)'}});
S.on('timer:ended',()=>showToast('â±ï¸ íƒ€ì´ë¨¸ ì¢…ë£Œ!'));
S.on('game:answers_revealed',d=>{renderRevealedAnswers(d)});
S.on('game:points_awarded',()=>showToast('ğŸ’° ì ìˆ˜ ì§€ê¸‰ ì™„ë£Œ!'));
S.on('event:like_updated',d=>{const el=$('likeCount');if(el)el.textContent=d.likes||0});

function $(id){return document.getElementById(id)}

// === Feature switching ===
function switchFeat(el,feat){
document.querySelectorAll('.feat-btn').forEach(b=>b.classList.remove('active'));
el.classList.add('active');curFeat=feat;responses=[];$('respList').innerHTML='';$('respCount').textContent='ì‘ë‹µ 0ëª…';
renderFeat();
}
function switchRightTab(el,tab){
document.querySelectorAll('.host-right .tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');
$('rtResp').style.display=tab==='resp'?'flex':'none';$('rtChat').style.display=tab==='hchat'?'flex':'none';
}

// === Render Feature ===
function renderFeat(){
const a=$('featureArea');
switch(curFeat){
case 'preparing':renderPreparing(a);break;
case 'management':renderManagement(a);break;
case 'score':renderScore(a);break;
case 'chat':renderChat(a);break;
case 'quiz_multiple':renderQuizMultiple(a);break;
case 'quiz_subjective':renderQuizSubjective(a);break;
case 'quiz_order':renderQuizOrder(a);break;
case 'buzzer':renderBuzzer(a);break;
case 'buzzer_count':renderBuzzerCount(a);break;
case 'code_number':renderCodeNumber(a);break;
case 'bingo':renderBingo(a);break;
case 'timer':renderTimerFeat(a);break;
case 'lottery':renderLottery(a);break;
case 'like':renderLike(a);break;
case 'settings':renderSettings(a);break;
default:a.innerHTML='<div class="empty"><p>ê¸°ëŠ¥ì„ ì„ íƒí•˜ì„¸ìš”</p></div>';
}
}

// Preparing
function renderPreparing(a){
a.innerHTML=`<div class="game-form"><h3>ğŸ“‹ ì´ë²¤íŠ¸ ì¤€ë¹„</h3>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
<div class="card-sm" style="background:var(--indigo-50);border:1px solid var(--indigo-200);border-radius:12px;padding:16px;text-align:center">
<div style="font-size:32px;font-weight:900;color:var(--indigo-600)">${P.length}</div><div style="font-size:12px;color:var(--indigo-600);font-weight:600">ì°¸ê°€ì</div></div>
<div class="card-sm" style="background:#F0FDF4;border:1px solid #BBF7D0;border-radius:12px;padding:16px;text-align:center">
<div style="font-size:32px;font-weight:900;color:#16A34A">${TEAMS.length}</div><div style="font-size:12px;color:#16A34A;font-weight:600">íŒ€</div></div>
</div>
<p style="font-size:13px;color:var(--text2)">ì°¸ê°€ ì½”ë“œ: <strong style="font-size:18px;color:var(--point-500)">{{ event.code }}</strong></p>
<p style="font-size:13px;color:var(--text3);margin-top:8px">ì°¸ê°€ìê°€ ì…ì¥í•œ í›„, ì¢Œì¸¡ ë©”ë‰´ì—ì„œ ê²Œì„ì„ ì„ íƒí•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”.</p>
<div class="game-actions"><button class="btn btn-primary" onclick="setDisplay('ëŒ€ê¸°')"><i class="ri-tv-line"></i> ëŒ€ê¸°í™”ë©´</button><button class="btn btn-outline" onclick="window.open('/event/monitor/'+E)"><i class="ri-external-link-line"></i> ëª¨ë‹ˆí„°</button></div>
</div>`;
}

// Management
function renderManagement(a){
let html=`<div class="game-form"><h3><i class="ri-group-line"></i> íŒ€/ê°œì¸ ê´€ë¦¬</h3>
<div class="tabs mb-4"><div class="tab active" onclick="switchMgmtTab(this,'pt')">ì°¸ê°€ì (${P.length})</div><div class="tab" onclick="switchMgmtTab(this,'tm')">íŒ€ (${TEAMS.length})</div></div>
<div id="mgmtPt"><table class="p-table"><thead><tr><th>ì´ë¦„</th><th>íŒ€</th><th>ì ìˆ˜</th><th>ìƒíƒœ</th><th></th></tr></thead><tbody>`;
P.forEach(p=>{
const team=TEAMS.find(t=>t.id==p.team_id);
html+=`<tr><td style="font-weight:600">${p.name}</td><td>${team?.name||'-'}</td><td style="font-weight:700;color:var(--point-500)">${p.score}</td><td><span class="badge badge-${p.status==='ì°¸ê°€'?'success':'gray'}">${p.status||'ì°¸ê°€'}</span></td><td><button class="btn btn-ghost btn-sm" onclick="kickParticipant(${p.id})"><i class="ri-close-line"></i></button></td></tr>`;
});
html+=`</tbody></table></div><div id="mgmtTm" class="hidden">`;
TEAMS.forEach(t=>{
const members=P.filter(p=>p.team_id==t.id);
html+=`<div class="card-sm mb-3"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${t.name}</strong> <span class="text-sm text-muted">(${members.length}ëª…)</span></div><span style="font-weight:800;color:var(--point-500)">${t.score}ì </span></div>
<div style="margin-top:8px;font-size:12px;color:var(--text3)">${members.map(m=>m.name).join(', ')||'ë©¤ë²„ ì—†ìŒ'}</div></div>`;
});
html+=`</div></div>`;
a.innerHTML=html;
}
function switchMgmtTab(el,tab){
document.querySelectorAll('.game-form .tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');
$('mgmtPt').classList.toggle('hidden',tab!=='pt');$('mgmtTm').classList.toggle('hidden',tab!=='tm');
}
function kickParticipant(pid){if(confirm('í‡´ì¥ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?'))S.emit('host:manage_participant',{eventId:E,action:'kick',participantId:pid})}

// Score
function renderScore(a){
let html=`<div class="game-form"><h3><i class="ri-trophy-line"></i> ì ìˆ˜ ê´€ë¦¬</h3>
<div class="flex gap-2 mb-4"><button class="btn btn-sm btn-outline" onclick="setDisplay('ê°œì¸ ì ìˆ˜')">ê°œì¸ ì ìˆ˜ í‘œì‹œ</button><button class="btn btn-sm btn-outline" onclick="setDisplay('íŒ€ ì ìˆ˜')">íŒ€ ì ìˆ˜ í‘œì‹œ</button></div>`;
if(TEAMS.length>0){
html+=`<h4 style="font-size:14px;font-weight:600;margin-bottom:8px">íŒ€ ì ìˆ˜</h4><table class="p-table mb-4"><thead><tr><th>íŒ€</th><th>ì ìˆ˜</th><th>ë³€ê²½</th></tr></thead><tbody>`;
TEAMS.forEach(t=>{html+=`<tr><td style="font-weight:600">${t.name}</td><td style="font-weight:700;color:var(--point-500)">${t.score}</td><td><div class="flex gap-2"><input type="number" class="score-input" id="ts${t.id}" value="0" min="-999" max="999"><button class="btn btn-sm btn-primary" onclick="updateTeamScore(${t.id})">ì ìš©</button></div></td></tr>`});
html+=`</tbody></table>`;
}
html+=`<h4 style="font-size:14px;font-weight:600;margin-bottom:8px">ê°œì¸ ì ìˆ˜</h4><table class="p-table"><thead><tr><th>#</th><th>ì´ë¦„</th><th>íŒ€</th><th>ì ìˆ˜</th><th>ë³€ê²½</th></tr></thead><tbody>`;
[...P].sort((a,b)=>b.score-a.score).forEach((p,i)=>{
const team=TEAMS.find(t=>t.id==p.team_id);
html+=`<tr><td>${i<3?['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]:(i+1)}</td><td style="font-weight:600">${p.name}</td><td>${team?.name||'-'}</td><td style="font-weight:700;color:var(--point-500)">${p.score}</td><td><div class="flex gap-2"><input type="number" class="score-input" id="ps${p.id}" value="0" min="-999" max="999"><button class="btn btn-sm btn-primary" onclick="updatePScore(${p.id})">ì ìš©</button></div></td></tr>`;
});
html+=`</tbody></table></div>`;
a.innerHTML=html;
}
function updateTeamScore(tid){const v=parseInt($('ts'+tid)?.value)||0;S.emit('host:update_team_score',{eventId:E,teamId:tid,score:v})}
function updatePScore(pid){const v=parseInt($('ps'+pid)?.value)||0;S.emit('host:update_participant_score',{eventId:E,participantId:pid,score:v})}

// Chat
function renderChat(a){
a.innerHTML=`<div class="game-form"><h3><i class="ri-chat-3-line"></i> ì±„íŒ… ê´€ë¦¬</h3>
<div class="flex gap-2 mb-4"><button class="btn btn-sm btn-outline" onclick="setDisplay('ì±„íŒ…')">ì±„íŒ… í™”ë©´ í‘œì‹œ</button>
<button class="btn btn-sm btn-danger" onclick="clearChat()"><i class="ri-delete-bin-line"></i> ì±„íŒ… ì´ˆê¸°í™”</button></div>
<label class="flex items-center gap-2" style="cursor:pointer;font-size:13px"><input type="checkbox" id="chatToggle" onchange="toggleChat(this.checked)" {% if event.chat_active %}checked{% endif %} style="width:auto"> ì±„íŒ… í™œì„±í™”</label>
</div>`;
}
function clearChat(){S.emit('chat:clear',{eventId:E});showToast('ì±„íŒ… ì´ˆê¸°í™”')}
function toggleChat(v){S.emit('host:update_event',{eventId:E,update:{chatActive:v?1:0}})}

// === GAME FEATURES ===
function gameFormHeader(title,icon,type){
GT=type;
return `<div class="game-form"><h3>${icon} ${title}</h3>
<div class="status-header"><div class="left"><span class="badge ${GID?'badge-success badge-dot':'badge-gray'}">${GID?'ì¤€ë¹„ë¨':'ë¯¸ì¤€ë¹„'}</span></div>
<div class="right"><button class="btn btn-sm btn-primary" onclick="prepareGame('${type}')"><i class="ri-add-line"></i> ì¤€ë¹„</button>
<button class="btn btn-sm btn-success" onclick="startGame()" ${GID?'':'disabled'}><i class="ri-play-fill"></i> ì‹œì‘</button>
<button class="btn btn-sm btn-danger" onclick="endGame()"><i class="ri-stop-fill"></i> ì¢…ë£Œ</button>
<button class="btn btn-sm btn-warning" onclick="gradeAnswers()"><i class="ri-check-double-line"></i> ì±„ì </button>
<button class="btn btn-sm btn-outline" onclick="awardPoints()"><i class="ri-coin-line"></i> ì§€ê¸‰</button></div></div>`;
}

// Quiz Multiple
function renderQuizMultiple(a){
a.innerHTML=gameFormHeader('ê°ê´€ì‹','ğŸ“','ê°ê´€ì‹')+`
<div class="form-group mt-4"><label>ë¬¸ì œ</label><textarea id="gQuestion" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”" rows="2"></textarea></div>
<div class="form-group"><label>ë³´ê¸° (ìµœëŒ€ 10ê°œ)</label>
<div id="optionsList">${[1,2,3,4].map(i=>`<div class="flex gap-2 mb-2"><span style="width:32px;height:38px;display:flex;align-items:center;justify-content:center;background:var(--bg3);border-radius:8px;font-weight:700;font-size:12px">${i}</span><input id="opt${i}" placeholder="ë³´ê¸° ${i}"></div>`).join('')}</div>
<button class="btn btn-sm btn-ghost" onclick="addOption()"><i class="ri-add-line"></i> ë³´ê¸° ì¶”ê°€</button></div>
<div class="form-row"><div class="form-group"><label>ì •ë‹µ ë²ˆí˜¸ (ì‰¼í‘œ êµ¬ë¶„)</label><input id="gAnswer" placeholder="1" value="1"></div>
<div class="form-group"><label>ì •ë‹µ ê°œìˆ˜</label><input type="number" id="gAnswerCnt" value="1" min="1" max="5"></div></div>
<div class="form-row"><div class="form-group"><label>ì ìˆ˜</label><input type="number" id="gPoints" value="10"></div>
<div class="form-group"><label>ì œí•œì‹œê°„ (ì´ˆ, 0=ë¬´ì œí•œ)</label><input type="number" id="gTime" value="30"></div></div>
</div>`;
}
let optCount=4;
function addOption(){optCount++;const el=$('optionsList');el.insertAdjacentHTML('beforeend',`<div class="flex gap-2 mb-2"><span style="width:32px;height:38px;display:flex;align-items:center;justify-content:center;background:var(--bg3);border-radius:8px;font-weight:700;font-size:12px">${optCount}</span><input id="opt${optCount}" placeholder="ë³´ê¸° ${optCount}"></div>`)}

// Quiz Subjective
function renderQuizSubjective(a){
a.innerHTML=gameFormHeader('ì£¼ê´€ì‹','âœï¸','ì£¼ê´€ì‹')+`
<div class="form-group mt-4"><label>ë¬¸ì œ</label><textarea id="gQuestion" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”" rows="2"></textarea></div>
<div class="form-row"><div class="form-group"><label>ì ìˆ˜</label><input type="number" id="gPoints" value="10"></div>
<div class="form-group"><label>ì œí•œì‹œê°„ (ì´ˆ)</label><input type="number" id="gTime" value="60"></div></div>
<div class="form-group"><label>ì •ë‹µ (ì±„ì ìš©, ì‰¼í‘œ êµ¬ë¶„)</label><input id="gAnswer" placeholder="ì •ë‹µ1, ì •ë‹µ2"></div>
</div>`;
}

// Quiz Order
function renderQuizOrder(a){
a.innerHTML=gameFormHeader('ìˆœì„œ ë§ì¶”ê¸°','ğŸ”¢','ìˆœì„œë§ì¶”ê¸°')+`
<div class="form-group mt-4"><label>ë¬¸ì œ</label><textarea id="gQuestion" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”" rows="2"></textarea></div>
<div class="form-group"><label>í•­ëª© (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label><textarea id="gItems" placeholder="í•­ëª©1\ní•­ëª©2\ní•­ëª©3\ní•­ëª©4" rows="4"></textarea></div>
<div class="form-row"><div class="form-group"><label>ì ìˆ˜</label><input type="number" id="gPoints" value="10"></div>
<div class="form-group"><label>ì œí•œì‹œê°„ (ì´ˆ)</label><input type="number" id="gTime" value="60"></div></div>
</div>`;
}

// Buzzer
function renderBuzzer(a){
a.innerHTML=gameFormHeader('ë¶€ì €','ğŸ””','ë¶€ì €')+`
<div class="form-group mt-4"><label>ì ìˆ˜</label><input type="number" id="gPoints" value="10"></div>
<p class="text-sm text-muted mt-2">ì°¸ê°€ìê°€ ê°€ì¥ ë¨¼ì € ë¶€ì €ë¥¼ ëˆ„ë¥´ë©´ ì‘ë‹µ ëª©ë¡ì— ìˆœì„œëŒ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p></div>`;
}

// Buzzer Count
function renderBuzzerCount(a){
a.innerHTML=gameFormHeader('ë¶€ì €ì¹´ìš´íŠ¸','âš¡','ë¶€ì €ì¹´ìš´íŠ¸')+`
<div class="form-row mt-4"><div class="form-group"><label>ëª©í‘œ í´ë¦­ ìˆ˜</label><input type="number" id="gTarget" value="100"></div>
<div class="form-group"><label>ê²Œì„ ëª¨ë“œ</label><select id="gMode"><option value="individual">ê°œì¸ì „</option><option value="team">íŒ€ì „</option></select></div></div>
<p class="text-sm text-muted mt-2">ëª©í‘œ í´ë¦­ ìˆ˜ì— ë¨¼ì € ë„ë‹¬í•˜ëŠ” ì°¸ê°€ì/íŒ€ì´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤.</p></div>`;
}

// Code Number
function renderCodeNumber(a){
a.innerHTML=gameFormHeader('ì½”ë“œë„˜ë²„','ğŸ”²','ì½”ë“œë„˜ë²„')+`
<div class="form-row mt-4"><div class="form-group"><label>ë³´ë“œ í¬ê¸°</label><input type="number" id="gBoardSize" value="9" min="4" max="20"></div>
<div class="form-group"><label>ìµœëŒ€ ìˆ«ì</label><input type="number" id="gMaxNum" value="30"></div></div>
<div class="form-group"><label>ì†ë„ (ì´ˆ)</label><input type="number" id="gSpeed" value="3"></div>
<div class="flex gap-2 mt-4"><button class="btn btn-primary" onclick="cnNext()"><i class="ri-skip-forward-fill"></i> ë‹¤ìŒ ìˆ«ì</button><button class="btn btn-success" onclick="cnAutoStart()">â–¶ ìë™</button><button class="btn btn-danger" onclick="cnAutoStop()">â–  ì •ì§€</button></div>
<div id="cnNum" class="cn-display">-</div></div>`;
}
function cnNext(){S.emit('host:code_number_next',{eventId:E,gameId:GID})}
function cnAutoStart(){S.emit('host:code_number_start_auto',{eventId:E,gameId:GID})}
function cnAutoStop(){S.emit('host:code_number_stop_auto',{eventId:E,gameId:GID})}

// Bingo
function renderBingo(a){
a.innerHTML=gameFormHeader('ë¹™ê³ ','ğŸ¯','ë¹™ê³ ')+`
<div class="form-row mt-4"><div class="form-group"><label>ë¹™ê³  í¬ê¸°</label><input type="number" id="gBingoSize" value="5" min="3" max="7"></div>
<div class="form-group"><label>íƒ€ì…</label><select id="gBingoType"><option value="ìˆ«ìë¹™ê³ ">ìˆ«ìë¹™ê³ </option><option value="ë‹¨ì–´ë¹™ê³ ">ë‹¨ì–´ë¹™ê³ </option></select></div></div>
<div class="form-group"><label>ì ìˆ˜ (ë¹™ê³  1ì¤„ë‹¹)</label><input type="number" id="gPoints" value="10"></div></div>`;
}

// Timer
function renderTimerFeat(a){
a.innerHTML=`<div class="game-form"><h3>â±ï¸ íƒ€ì´ë¨¸</h3>
<div class="status-header"><div class="left"><span class="badge ${GID?'badge-success badge-dot':'badge-gray'}">${GID?'ì¤€ë¹„ë¨':'ë¯¸ì¤€ë¹„'}</span></div>
<div class="right"><button class="btn btn-sm btn-primary" onclick="prepareTimer()"><i class="ri-add-line"></i> ì¤€ë¹„</button>
<button class="btn btn-sm btn-success" onclick="startTimer()" ${GID?'':'disabled'}><i class="ri-play-fill"></i> ì‹œì‘</button>
<button class="btn btn-sm btn-danger" onclick="endTimer()"><i class="ri-stop-fill"></i> ì¢…ë£Œ</button></div></div>
<div class="form-row mt-4"><div class="form-group"><label>ì‹œê°„ (ì´ˆ)</label><input type="number" id="gTimeLimit" value="60"></div>
<div class="form-group"><label>íƒ€ì…</label><select id="gTimerType"><option value="participant">ê°œë³„</option><option value="team">íŒ€</option></select></div></div>
<div id="timerDisp" style="font-size:72px;font-weight:900;text-align:center;color:var(--point-500);margin:16px 0;font-family:monospace">--:--</div></div>`;
}

// Lottery
function renderLottery(a){
a.innerHTML=`<div class="game-form"><h3>ğŸ í–‰ìš´ê¶Œ ì¶”ì²¨</h3>
<div class="form-group"><label>ë‹¹ì²¨ì ìˆ˜</label><input type="number" id="gWinnerCnt" value="1" min="1"></div>
<button class="btn btn-primary btn-lg btn-block mt-4" onclick="doLottery()"><i class="ri-gift-line"></i> ì¶”ì²¨í•˜ê¸°!</button>
<div id="lotteryRes" class="lottery-result mt-4"></div></div>`;
}

// Like
function renderLike(a){
a.innerHTML=`<div class="game-form"><h3>â¤ï¸ ì¢‹ì•„ìš”</h3>
<label class="flex items-center gap-2 mb-3" style="cursor:pointer;font-size:13px"><input type="checkbox" id="likeToggle" onchange="toggleLike(this.checked)" {% if event.like_active %}checked{% endif %} style="width:auto"> ì¢‹ì•„ìš” í™œì„±í™”</label>
<button class="btn btn-sm btn-outline" onclick="setDisplay('ì¢‹ì•„ìš”')">ì¢‹ì•„ìš” í™”ë©´ í‘œì‹œ</button>
<div class="text-center mt-4"><div style="font-size:48px">â¤ï¸</div><div style="font-size:36px;font-weight:900;color:var(--danger);margin-top:8px" id="likeCount">0</div></div></div>`;
}
function toggleLike(v){S.emit('host:update_event',{eventId:E,update:{likeActive:v?1:0}})}

// Settings
function renderSettings(a){
a.innerHTML=`<div class="game-form"><h3><i class="ri-settings-3-line"></i> ì„¤ì •</h3>
<div class="form-group"><label>ì°¸ê°€ì í™”ë©´ ëª¨ë“œ</label><select id="displaySelect" onchange="setDisplay(this.value)">
<option value="ëŒ€ê¸°">ëŒ€ê¸°</option><option value="ì ìˆ˜">ì ìˆ˜</option><option value="ê°œì¸ ì ìˆ˜">ê°œì¸ ì ìˆ˜</option><option value="íŒ€ ì ìˆ˜">íŒ€ ì ìˆ˜</option><option value="ì±„íŒ…">ì±„íŒ…</option><option value="ì¢‹ì•„ìš”">ì¢‹ì•„ìš”</option><option value="ì¶”ì²¨">ì¶”ì²¨</option><option value="íƒ€ì´ë¨¸">íƒ€ì´ë¨¸</option><option value="ê´€ë¦¬">ê´€ë¦¬</option>
</select></div>
<div class="form-group"><label>íŒ€ ì ìˆ˜ ê³„ì‚° ë°©ì‹</label><select id="teamScoreType" onchange="setTeamScoreType(this.value)">
<option value="sum" ${{'{{ "selected" if event.team_score_type == "sum" else "" }}'}}>í•©ì‚°</option><option value="average" ${{'{{ "selected" if event.team_score_type == "average" else "" }}'}}>í‰ê· </option>
</select></div>
<p class="text-sm text-muted mt-2">ê´€ë¦¬ í˜ì´ì§€: <a href="/dashboard/event/{{ event.id }}/manage" class="text-primary" target="_blank">ì´ë²¤íŠ¸ ê´€ë¦¬ â†’</a></p>
</div>`;
}

// === Game Actions ===
function prepareGame(type){
GT=type;let s={};
if(type==='ê°ê´€ì‹'){
const opts=[];for(let i=1;i<=optCount;i++){const v=$('opt'+i)?.value;if(v)opts.push(v)}
const ans=($('gAnswer')?.value||'1').split(',').map(x=>parseInt(x.trim()));
s={quiz:{question:$('gQuestion')?.value||'',options:opts,answer:ans},points:parseInt($('gPoints')?.value)||10,timeLimit:parseInt($('gTime')?.value)||30,answerCount:parseInt($('gAnswerCnt')?.value)||1,correctAnswers:ans};
}else if(type==='ì£¼ê´€ì‹'){
s={quiz:{question:$('gQuestion')?.value||''},points:parseInt($('gPoints')?.value)||10,timeLimit:parseInt($('gTime')?.value)||60};
}else if(type==='ìˆœì„œë§ì¶”ê¸°'){
const items=($('gItems')?.value||'').split('\n').filter(x=>x.trim());
s={sequence:{question:$('gQuestion')?.value||'',items},points:parseInt($('gPoints')?.value)||10,timeLimit:parseInt($('gTime')?.value)||60};
}else if(type==='ë¶€ì €'){
s={points:parseInt($('gPoints')?.value)||10};
}else if(type==='ë¶€ì €ì¹´ìš´íŠ¸'){
s={buzzerCount:{targetClicks:parseInt($('gTarget')?.value)||100,gameMode:$('gMode')?.value||'individual'}};
}else if(type==='ì½”ë“œë„˜ë²„'){
s={codeNumber:{boardSize:parseInt($('gBoardSize')?.value)||9,maxNumber:parseInt($('gMaxNum')?.value)||30,gameSpeed:parseInt($('gSpeed')?.value)||3}};
}else if(type==='ë¹™ê³ '){
s={bingo:{size:parseInt($('gBingoSize')?.value)||5,type:$('gBingoType')?.value||'ìˆ«ìë¹™ê³ '},points:parseInt($('gPoints')?.value)||10};
}
S.emit('host:prepare_game',{eventId:E,type,settings:s});
}
function startGame(){if(!GID)return showToast('ë¨¼ì € ì¤€ë¹„í•˜ì„¸ìš”','error');
let s={};if(GT==='ê°ê´€ì‹'){const opts=[];for(let i=1;i<=optCount;i++){const v=$('opt'+i)?.value;if(v)opts.push(v)}
const ans=($('gAnswer')?.value||'1').split(',').map(x=>parseInt(x.trim()));
s={quiz:{question:$('gQuestion')?.value||'',options:opts,answer:ans},points:parseInt($('gPoints')?.value)||10,timeLimit:parseInt($('gTime')?.value)||30,answerCount:parseInt($('gAnswerCnt')?.value)||1,correctAnswers:ans};}
else if(GT==='ì£¼ê´€ì‹')s={quiz:{question:$('gQuestion')?.value||''},points:parseInt($('gPoints')?.value)||10,timeLimit:parseInt($('gTime')?.value)||60};
else if(GT==='ìˆœì„œë§ì¶”ê¸°'){const items=($('gItems')?.value||'').split('\n').filter(x=>x.trim());s={sequence:{question:$('gQuestion')?.value||'',items},points:parseInt($('gPoints')?.value)||10,timeLimit:parseInt($('gTime')?.value)||60};}
S.emit('host:start_game',{eventId:E,gameId:GID,settings:s});
}
function endGame(){if(GID)S.emit('host:end_game',{eventId:E,gameId:GID})}
function gradeAnswers(){
const ans=$('gAnswer')?.value;
if(!ans)return showToast('ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”','error');
const arr=ans.split(',').map(x=>x.trim());
S.emit('host:correct_answers',{eventId:E,gameId:GID,correctAnswers:arr});
S.emit('host:grade_answers',{eventId:E,gameId:GID,correctAnswers:arr});
}
function awardPoints(){S.emit('host:award_points',{eventId:E,gameId:GID})}

// Timer
function prepareTimer(){const s={timeLimit:parseInt($('gTimeLimit')?.value)||60,timer:{type:$('gTimerType')?.value||'participant'}};
S.emit('host:prepare_timer',{eventId:E,settings:s})}
function startTimer(){S.emit('host:start_timer',{eventId:E,timerId:GID})}
function endTimer(){S.emit('host:end_timer',{eventId:E,timerId:GID})}

// Lottery
function doLottery(){S.emit('host:lottery_add',{eventId:E,gameId:GID,winnerCount:parseInt($('gWinnerCnt')?.value)||1})}

// Display mode
function setDisplay(mode){S.emit('host:display_mode',{eventId:E,displayMode:mode})}
function setTeamScoreType(type){S.emit('host:update_event',{eventId:E,update:{teamScoreType:type}})}

// Event controls
function startEvent(){S.emit('host:start_event',{eventId:E})}
function endEvent(){if(confirm('ì´ë²¤íŠ¸ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))S.emit('host:end_event',{eventId:E})}

// Response tracking
function addResponse(d){
responses.push(d);
const rl=$('respList');
const div=document.createElement('div');div.className='resp-item';
div.innerHTML=`<span class="name">${d.participantName||'ì°¸ê°€ì'}</span><span class="answer">${typeof d.answer==='object'?JSON.stringify(d.answer):d.answer}</span>`;
rl.prepend(div);
$('respCount').textContent=`ì‘ë‹µ ${responses.length}ëª…`;
}
function updateBCResponse(d){
const rl=$('respList');let el=rl.querySelector(`[data-pid="${d.participantId}"]`);
const p=P.find(x=>x.id==d.participantId);
if(!el){el=document.createElement('div');el.className='lb-item';el.dataset.pid=d.participantId;rl.appendChild(el)}
el.innerHTML=`<span class="rank">${rl.children.length}</span><span style="flex:1;font-weight:600">${p?.name||'?'}</span><span class="clicks">${d.clicks}</span>`;
// Sort by clicks desc
const items=[...rl.children].sort((a,b)=>(parseInt(b.querySelector('.clicks')?.textContent)||0)-(parseInt(a.querySelector('.clicks')?.textContent)||0));
items.forEach((it,i)=>{it.querySelector('.rank').textContent=i+1;rl.appendChild(it)});
}
function renderRevealedAnswers(d){
const rl=$('respList');rl.innerHTML='';
d.responses.forEach(r=>{
const p=P.find(x=>x.id==r.participantId);
const div=document.createElement('div');div.className='resp-item';
div.innerHTML=`<span class="name">${p?.name||'?'}: ${r.answer||'-'}</span><span style="font-weight:700;color:${r.isCorrect?'var(--success)':'var(--danger)'}">${r.isCorrect?'âœ… +'+r.earnedPoints:'âŒ'}</span>`;
rl.appendChild(div);
});
const btn=document.createElement('button');btn.className='btn btn-success btn-sm btn-block mt-2';btn.textContent='ğŸ’° ì ìˆ˜ ì§€ê¸‰';
btn.onclick=()=>S.emit('host:award_points',{eventId:E,gameId:d.gameId});
rl.appendChild(btn);
$('respCount').textContent=`ê²°ê³¼ ${d.responses.length}ëª…`;
}

// Chat
function hSendChat(){const i=$('hChatIn');if(!i.value.trim())return;S.emit('chat:send',{eventId:E,message:i.value,senderName:'í˜¸ìŠ¤íŠ¸',type:'all',author:'host'});i.value=''}
function addHChat(d){const el=$('hChatMsgs');if(!el)return;const div=document.createElement('div');div.className='chat-msg '+(d.author==='host'?'mine':'other');div.innerHTML='<div class="sender">'+(d.senderName||'')+'</div>'+d.message;el.appendChild(div);el.scrollTop=el.scrollHeight}

// Init
renderFeat();
</script>
{% endblock %}
