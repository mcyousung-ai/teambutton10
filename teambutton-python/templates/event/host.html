{% extends "base.html" %}
{% block nav %}{% endblock %}
{% block title %}í˜¸ìŠ¤íŠ¸ - {{ event.title }}{% endblock %}
{% block extra_css %}
<style>
body{background:#f8fafc;overflow:hidden}
.host-wrap{display:flex;height:100vh}
.host-left{width:72px;background:#fff;border-right:1px solid #e2e8f0;display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;padding:8px 0}
.host-left .logo{padding:10px;text-align:center;border-bottom:1px solid #e2e8f0;margin-bottom:4px}
.feat-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 4px;cursor:pointer;transition:all .15s;border:none;background:none;width:100%;gap:2px;border-left:3px solid transparent}
.feat-btn:hover{background:#eef2ff}
.feat-btn.active{background:#eef2ff;border-left-color:#5669FF}
.feat-btn i{font-size:18px;color:#64748b}
.feat-btn.active i{color:#5669FF}
.feat-btn span{font-size:9px;color:#94a3b8;white-space:nowrap}
.feat-btn.active span{color:#495BE0;font-weight:600}
.feat-sep{height:1px;background:#e2e8f0;margin:4px 8px}
.host-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.host-top{background:#fff;border-bottom:1px solid #e2e8f0;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.host-top h3{font-size:15px;font-weight:700}
.host-content{flex:1;overflow-y:auto;padding:20px}
.feat-content{max-width:900px;margin:0 auto}
.host-right{width:300px;background:#fff;border-left:1px solid #e2e8f0;display:flex;flex-direction:column;flex-shrink:0}
.resp-list{flex:1;overflow-y:auto;padding:8px}
.resp-item{padding:8px 10px;border-bottom:1px solid #f1f5f9;font-size:13px;display:flex;justify-content:space-between;align-items:center}
.resp-count{padding:8px 12px;background:#f1f5f9;font-size:12px;font-weight:600;color:#64748b;text-align:center;border-bottom:1px solid #e2e8f0}
.game-form{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
.game-form h3{font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.status-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;border:1px solid #e2e8f0;border-radius:12px;margin-bottom:16px;flex-wrap:wrap;gap:8px}
.ctrl-btns{display:flex;flex-wrap:wrap;gap:6px}
.p-table{width:100%;font-size:12px;border-collapse:collapse}
.p-table th{padding:8px 10px;background:#f8fafc;font-weight:600;color:#64748b;text-align:left;border-bottom:1px solid #e2e8f0}
.p-table td{padding:8px 10px;border-bottom:1px solid #f1f5f9}
.p-table tr:hover{background:#eef2ff}
.score-input{width:65px;padding:4px 6px;font-size:12px;text-align:center;border-radius:8px}
.cn-display{font-size:80px;font-weight:900;text-align:center;color:#5669FF;margin:16px 0;line-height:1}
.qr-box{text-align:center;margin-top:12px;padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e2e8f0}
@media(max-width:900px){.host-right{display:none}.host-left{width:56px}.feat-btn span{display:none}}
</style>
{% endblock %}
{% block content %}
<div class="host-wrap">
<div class="host-left">
<div class="logo"><strong style="color:#5669FF;font-size:14px">TB</strong></div>
<button class="feat-btn active" data-f="preparing" onclick="sf(this,'preparing')"><i class="ri-home-4-line"></i><span>ì¤€ë¹„</span></button>
<button class="feat-btn" data-f="management" onclick="sf(this,'management')"><i class="ri-group-line"></i><span>íŒ€/ê°œì¸</span></button>
<button class="feat-btn" data-f="score" onclick="sf(this,'score')"><i class="ri-trophy-line"></i><span>ì ìˆ˜</span></button>
<button class="feat-btn" data-f="chat" onclick="sf(this,'chat')"><i class="ri-chat-3-line"></i><span>ì±„íŒ…</span></button>
<div class="feat-sep"></div>
<button class="feat-btn" data-f="quiz_multiple" onclick="sf(this,'quiz_multiple')"><i class="ri-checkbox-multiple-line"></i><span>ê°ê´€ì‹</span></button>
<button class="feat-btn" data-f="quiz_subjective" onclick="sf(this,'quiz_subjective')"><i class="ri-pencil-line"></i><span>ì£¼ê´€ì‹</span></button>
<button class="feat-btn" data-f="quiz_order" onclick="sf(this,'quiz_order')"><i class="ri-sort-number-asc"></i><span>ìˆœì„œ</span></button>
<button class="feat-btn" data-f="buzzer" onclick="sf(this,'buzzer')"><i class="ri-alarm-warning-line"></i><span>ë¶€ì €</span></button>
<button class="feat-btn" data-f="buzzer_count" onclick="sf(this,'buzzer_count')"><i class="ri-speed-line"></i><span>ë¶€ì €ì¹´ìš´íŠ¸</span></button>
<button class="feat-btn" data-f="code_number" onclick="sf(this,'code_number')"><i class="ri-grid-line"></i><span>ì½”ë“œë„˜ë²„</span></button>
<button class="feat-btn" data-f="bingo" onclick="sf(this,'bingo')"><i class="ri-layout-grid-line"></i><span>ë¹™ê³ </span></button>
<div class="feat-sep"></div>
<button class="feat-btn" data-f="timer" onclick="sf(this,'timer')"><i class="ri-timer-line"></i><span>íƒ€ì´ë¨¸</span></button>
<button class="feat-btn" data-f="lottery" onclick="sf(this,'lottery')"><i class="ri-gift-line"></i><span>ì¶”ì²¨</span></button>
<button class="feat-btn" data-f="like" onclick="sf(this,'like')"><i class="ri-heart-line"></i><span>ì¢‹ì•„ìš”</span></button>
<div class="feat-sep"></div>
<button class="feat-btn" data-f="settings" onclick="sf(this,'settings')"><i class="ri-settings-3-line"></i><span>ì„¤ì •</span></button>
</div>
<div class="host-main">
<div class="host-top">
<div style="display:flex;align-items:center;gap:10px">
<h3>{{ event.title }}</h3>
<span class="badge badge-gray" id="evBadge">{{ event.status }}</span>
<span style="font-size:12px;color:#94a3b8"><i class="ri-group-line"></i> <span id="pCnt">0</span>ëª…</span>
</div>
<div style="display:flex;align-items:center;gap:12px">
<span style="font-size:20px;font-weight:900;color:#5669FF;letter-spacing:1px">{{ event.code }}</span>
<button class="btn btn-sm btn-success" id="btnStart"><i class="ri-play-fill"></i> ì‹œì‘</button>
<button class="btn btn-sm btn-danger" id="btnEnd"><i class="ri-stop-fill"></i> ì¢…ë£Œ</button>
</div>
</div>
<div class="host-content"><div class="feat-content" id="FA"></div></div>
</div>
<div class="host-right">
<div class="tabs"><div class="tab active" id="rtTabResp">ì‘ë‹µ</div><div class="tab" id="rtTabChat">ì±„íŒ…</div></div>
<div id="rtResp" style="flex:1;display:flex;flex-direction:column"><div class="resp-count" id="respCnt">ì‘ë‹µ 0ëª…</div><div class="resp-list" id="RL"></div></div>
<div id="rtChat" style="display:none;flex:1;flex-direction:column"><div style="flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:4px" id="HCM"></div>
<div class="chat-input"><input type="text" id="hci" placeholder="ë©”ì‹œì§€..." style="flex:1"><button class="btn btn-sm btn-primary" id="hcSend">ì „ì†¡</button></div></div>
</div>
</div>
<script>
var EID = {{ event.id }};
var ECODE = '{{ event.code }}';
var ETEAMS = {{ teams|tojson|safe }};
var EP = {{ participants|tojson|safe }};
var EURL = location.origin + '/join/' + ECODE;
</script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
(function(){
var S = io();
var GID = null, GT = null, curFeat = 'preparing', responses = [];
var optCount = 4;

S.emit('host:join', {eventId: EID});

function $(id){ return document.getElementById(id); }

// Right tab
$('rtTabResp').onclick = function(){ this.classList.add('active'); $('rtTabChat').classList.remove('active'); $('rtResp').style.display='flex'; $('rtChat').style.display='none'; };
$('rtTabChat').onclick = function(){ this.classList.add('active'); $('rtTabResp').classList.remove('active'); $('rtResp').style.display='none'; $('rtChat').style.display='flex'; };

// Events
$('btnStart').onclick = function(){ S.emit('host:start_event', {eventId: EID}); };
$('btnEnd').onclick = function(){ if(confirm('ì´ë²¤íŠ¸ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) S.emit('host:end_event', {eventId: EID}); };
$('hcSend').onclick = function(){ var v=$('hci').value; if(!v.trim())return; S.emit('chat:send',{eventId:EID,message:v,senderName:'í˜¸ìŠ¤íŠ¸',type:'all',author:'host'}); $('hci').value=''; };
$('hci').onkeypress = function(e){ if(e.key==='Enter') $('hcSend').click(); };

// Socket listeners
S.on('event:started', function(){ $('evBadge').textContent='ì§„í–‰ì¤‘'; $('evBadge').className='badge badge-success'; showToast('ì´ë²¤íŠ¸ ì‹œì‘!'); });
S.on('event:ended', function(){ $('evBadge').textContent='ì¢…ë£Œ'; $('evBadge').className='badge badge-danger'; });
S.on('participants:updated', function(d){ EP=d.participants; $('pCnt').textContent=EP.length; if(curFeat==='management'||curFeat==='score') rf(); });
S.on('chat:message', function(d){ addHChat(d); });
S.on('game:prepared', function(d){ GID=d.gameId; showToast(GT+' ê²Œì„ ì¤€ë¹„ ì™„ë£Œ'); rf(); });
S.on('timer:prepared', function(d){ GID=d.timerId; showToast('íƒ€ì´ë¨¸ ì¤€ë¹„ ì™„ë£Œ'); rf(); });
S.on('game:started', function(){ showToast('ê²Œì„ ì‹œì‘!'); responses=[]; });
S.on('game:ended', function(){ showToast('ê²Œì„ ì¢…ë£Œ'); });
S.on('game:response', function(d){ addResp(d); });
S.on('game:buzzer_count_click', function(d){ updateBC(d); });
S.on('game:buzzer_count_winner', function(d){ showToast('ğŸ† ìš°ìŠ¹: '+(d.winner?d.winner.name:'')); });
S.on('game:code_number_next', function(d){ var el=$('cnNum'); if(el) el.textContent=(d.number===0?'ğŸƒ':d.number); });
S.on('game:lottery_result', function(d){ var el=$('lotRes'); if(el) el.innerHTML='ğŸ‰ '+d.winners.join(', '); });
S.on('timer:tick', function(d){ var el=$('tDisp'); if(el){var m=Math.floor(d.remaining/60),s=d.remaining%60; el.textContent=m+':'+String(s).padStart(2,'0'); if(d.remaining<=10) el.style.color='#EF4444';} });
S.on('timer:ended', function(){ showToast('â±ï¸ íƒ€ì´ë¨¸ ì¢…ë£Œ!'); });
S.on('game:answers_revealed', function(d){ renderRevealed(d); });
S.on('game:points_awarded', function(){ showToast('ğŸ’° ì ìˆ˜ ì§€ê¸‰ ì™„ë£Œ!'); });
S.on('event:like_updated', function(d){ var el=$('likeCnt'); if(el) el.textContent=d.likes||0; });

// Feature switch
window.sf = function(el, feat){
  document.querySelectorAll('.feat-btn').forEach(function(b){b.classList.remove('active');});
  el.classList.add('active'); curFeat=feat; responses=[]; $('RL').innerHTML=''; $('respCnt').textContent='ì‘ë‹µ 0ëª…';
  rf();
};

function rf(){
  var a = $('FA');
  switch(curFeat){
    case 'preparing': rPreparing(a); break;
    case 'management': rManagement(a); break;
    case 'score': rScore(a); break;
    case 'chat': rChat(a); break;
    case 'quiz_multiple': rQuizM(a); break;
    case 'quiz_subjective': rQuizS(a); break;
    case 'quiz_order': rQuizO(a); break;
    case 'buzzer': rBuzzer(a); break;
    case 'buzzer_count': rBuzzerC(a); break;
    case 'code_number': rCodeNum(a); break;
    case 'bingo': rBingo(a); break;
    case 'timer': rTimer(a); break;
    case 'lottery': rLottery(a); break;
    case 'like': rLike(a); break;
    case 'settings': rSettings(a); break;
    default: a.innerHTML='<p>ê¸°ëŠ¥ì„ ì„ íƒí•˜ì„¸ìš”</p>';
  }
}

// --- PREPARING ---
function rPreparing(a){
  a.innerHTML='<div class="game-form"><h3>ğŸ“‹ ì´ë²¤íŠ¸ ì¤€ë¹„</h3>'+
  '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">'+
  '<div style="background:#eef2ff;border:1px solid #c7d2fe;border-radius:12px;padding:16px;text-align:center"><div style="font-size:32px;font-weight:900;color:#4f46e5">'+EP.length+'</div><div style="font-size:12px;color:#4f46e5;font-weight:600">ì°¸ê°€ì</div></div>'+
  '<div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:16px;text-align:center"><div style="font-size:32px;font-weight:900;color:#16a34a">'+ETEAMS.length+'</div><div style="font-size:12px;color:#16a34a;font-weight:600">íŒ€</div></div></div>'+
  '<p style="font-size:14px">ì°¸ê°€ ì½”ë“œ: <strong style="font-size:22px;color:#5669FF">'+ECODE+'</strong></p>'+
  '<p style="font-size:13px;color:#94a3b8;margin-top:4px">ì°¸ê°€ URL: <a href="'+EURL+'" target="_blank" style="color:#5669FF">'+EURL+'</a></p>'+
  '<div class="qr-box"><canvas id="qrCanvas"></canvas><p style="font-size:11px;color:#94a3b8;margin-top:8px">QRì½”ë“œë¡œ ì°¸ê°€í•˜ê¸°</p></div>'+
  '<div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-primary" id="pBtnWait">ëŒ€ê¸°í™”ë©´</button><button class="btn btn-outline" id="pBtnMon">ëª¨ë‹ˆí„° ì—´ê¸°</button></div>'+
  '</div>';
  // QR
  if(typeof QRCode!=='undefined'){
    QRCode.toCanvas($('qrCanvas'), EURL, {width:200,margin:2}, function(err){});
  }
  $('pBtnWait').onclick=function(){setDisp('ëŒ€ê¸°');};
  $('pBtnMon').onclick=function(){window.open('/event/monitor/'+EID);};
}

// --- MANAGEMENT ---
function rManagement(a){
  var h='<div class="game-form"><h3><i class="ri-group-line"></i> íŒ€/ê°œì¸ ê´€ë¦¬</h3>'+
  '<table class="p-table"><thead><tr><th>ì´ë¦„</th><th>íŒ€</th><th>ì ìˆ˜</th><th>ìƒíƒœ</th><th></th></tr></thead><tbody>';
  EP.forEach(function(p){
    var tn='-'; ETEAMS.forEach(function(t){if(t.id==p.team_id)tn=t.name;});
    h+='<tr><td style="font-weight:600">'+p.name+'</td><td>'+tn+'</td><td style="font-weight:700;color:#5669FF">'+p.score+'</td><td><span class="badge badge-success">ì°¸ê°€</span></td><td><button class="btn btn-ghost btn-sm kick-btn" data-pid="'+p.id+'"><i class="ri-close-line"></i></button></td></tr>';
  });
  h+='</tbody></table></div>';
  a.innerHTML=h;
  a.querySelectorAll('.kick-btn').forEach(function(b){
    b.onclick=function(){if(confirm('í‡´ì¥ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?'))S.emit('host:manage_participant',{eventId:EID,action:'kick',participantId:parseInt(this.dataset.pid)});};
  });
}

// --- SCORE ---
function rScore(a){
  var h='<div class="game-form"><h3><i class="ri-trophy-line"></i> ì ìˆ˜ ê´€ë¦¬</h3>'+
  '<div style="display:flex;gap:8px;margin-bottom:16px"><button class="btn btn-sm btn-outline score-disp" data-m="ê°œì¸ ì ìˆ˜">ê°œì¸ ì ìˆ˜ í‘œì‹œ</button><button class="btn btn-sm btn-outline score-disp" data-m="íŒ€ ì ìˆ˜">íŒ€ ì ìˆ˜ í‘œì‹œ</button></div>';
  if(ETEAMS.length>0){
    h+='<h4 style="font-size:14px;font-weight:600;margin-bottom:8px">íŒ€ ì ìˆ˜</h4><table class="p-table mb-4"><thead><tr><th>íŒ€</th><th>ì ìˆ˜</th><th>ë³€ê²½</th></tr></thead><tbody>';
    ETEAMS.forEach(function(t){h+='<tr><td style="font-weight:600">'+t.name+'</td><td style="font-weight:700;color:#5669FF">'+t.score+'</td><td><div style="display:flex;gap:4px"><input type="number" class="score-input ts-in" data-tid="'+t.id+'" value="0"><button class="btn btn-sm btn-primary ts-btn" data-tid="'+t.id+'">ì ìš©</button></div></td></tr>';});
    h+='</tbody></table>';
  }
  h+='<h4 style="font-size:14px;font-weight:600;margin-bottom:8px">ê°œì¸ ì ìˆ˜</h4><table class="p-table"><thead><tr><th>#</th><th>ì´ë¦„</th><th>íŒ€</th><th>ì ìˆ˜</th><th>ë³€ê²½</th></tr></thead><tbody>';
  EP.slice().sort(function(a,b){return b.score-a.score;}).forEach(function(p,i){
    var tn='-'; ETEAMS.forEach(function(t){if(t.id==p.team_id)tn=t.name;});
    h+='<tr><td>'+(i<3?['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]:(i+1))+'</td><td style="font-weight:600">'+p.name+'</td><td>'+tn+'</td><td style="font-weight:700;color:#5669FF">'+p.score+'</td><td><div style="display:flex;gap:4px"><input type="number" class="score-input ps-in" data-pid="'+p.id+'" value="0"><button class="btn btn-sm btn-primary ps-btn" data-pid="'+p.id+'">ì ìš©</button></div></td></tr>';
  });
  h+='</tbody></table></div>';
  a.innerHTML=h;
  a.querySelectorAll('.score-disp').forEach(function(b){b.onclick=function(){setDisp(this.dataset.m);};});
  a.querySelectorAll('.ts-btn').forEach(function(b){b.onclick=function(){var v=parseInt(a.querySelector('.ts-in[data-tid="'+this.dataset.tid+'"]').value)||0;S.emit('host:update_team_score',{eventId:EID,teamId:parseInt(this.dataset.tid),score:v});};});
  a.querySelectorAll('.ps-btn').forEach(function(b){b.onclick=function(){var v=parseInt(a.querySelector('.ps-in[data-pid="'+this.dataset.pid+'"]').value)||0;S.emit('host:update_participant_score',{eventId:EID,participantId:parseInt(this.dataset.pid),score:v});};});
}

// --- CHAT ---
function rChat(a){
  a.innerHTML='<div class="game-form"><h3><i class="ri-chat-3-line"></i> ì±„íŒ… ê´€ë¦¬</h3>'+
  '<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-sm btn-outline" id="cDispBtn">ì±„íŒ… í™”ë©´ í‘œì‹œ</button><button class="btn btn-sm btn-danger" id="cClearBtn"><i class="ri-delete-bin-line"></i> ì´ˆê¸°í™”</button></div></div>';
  $('cDispBtn').onclick=function(){setDisp('ì±„íŒ…');};
  $('cClearBtn').onclick=function(){S.emit('chat:clear',{eventId:EID});showToast('ì±„íŒ… ì´ˆê¸°í™”');};
}

// --- GAME HEADER ---
function gHead(title,icon,type){
  GT=type;
  return '<div class="game-form"><h3>'+icon+' '+title+'</h3>'+
  '<div class="status-header"><div><span class="badge '+(GID?'badge-success':'badge-gray')+'">'+(GID?'ì¤€ë¹„ë¨':'ë¯¸ì¤€ë¹„')+'</span></div>'+
  '<div class="ctrl-btns"><button class="btn btn-sm btn-primary g-prep" data-t="'+type+'"><i class="ri-add-line"></i> ì¤€ë¹„</button>'+
  '<button class="btn btn-sm btn-success g-start" '+(GID?'':'disabled')+'><i class="ri-play-fill"></i> ì‹œì‘</button>'+
  '<button class="btn btn-sm btn-danger g-end"><i class="ri-stop-fill"></i> ì¢…ë£Œ</button>'+
  '<button class="btn btn-sm btn-warning g-grade"><i class="ri-check-double-line"></i> ì±„ì </button>'+
  '<button class="btn btn-sm btn-outline g-award"><i class="ri-coin-line"></i> ì§€ê¸‰</button></div></div>';
}
function bindGameBtns(a){
  var pb=a.querySelector('.g-prep'); if(pb) pb.onclick=function(){prepareGame(this.dataset.t);};
  var sb=a.querySelector('.g-start'); if(sb) sb.onclick=function(){startGame();};
  var eb=a.querySelector('.g-end'); if(eb) eb.onclick=function(){endGame();};
  var gb=a.querySelector('.g-grade'); if(gb) gb.onclick=function(){gradeAnswers();};
  var ab=a.querySelector('.g-award'); if(ab) ab.onclick=function(){awardPoints();};
}

// --- QUIZ MULTIPLE ---
function rQuizM(a){
  optCount=4;
  a.innerHTML=gHead('ê°ê´€ì‹','ğŸ“','ê°ê´€ì‹')+
  '<div class="form-group mt-3"><label>ë¬¸ì œ</label><textarea id="gQ" placeholder="ë¬¸ì œ ì…ë ¥" rows="2"></textarea></div>'+
  '<div class="form-group"><label>ë³´ê¸°</label><div id="optList">'+
  [1,2,3,4].map(function(i){return '<div style="display:flex;gap:6px;margin-bottom:6px"><span style="width:32px;height:38px;display:flex;align-items:center;justify-content:center;background:#f1f5f9;border-radius:8px;font-weight:700;font-size:12px">'+i+'</span><input id="opt'+i+'" placeholder="ë³´ê¸° '+i+'"></div>';}).join('')+
  '</div><button class="btn btn-sm btn-ghost" id="addOptBtn"><i class="ri-add-line"></i> ë³´ê¸° ì¶”ê°€</button></div>'+
  '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="form-group"><label>ì •ë‹µ ë²ˆí˜¸ (ì‰¼í‘œêµ¬ë¶„)</label><input id="gA" value="1"></div><div class="form-group"><label>ì •ë‹µ ê°œìˆ˜</label><input type="number" id="gAC" value="1" min="1"></div></div>'+
  '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="form-group"><label>ì ìˆ˜</label><input type="number" id="gP" value="10"></div><div class="form-group"><label>ì œí•œì‹œê°„(ì´ˆ, 0=ë¬´ì œí•œ)</label><input type="number" id="gT" value="30"></div></div></div>';
  bindGameBtns(a);
  $('addOptBtn').onclick=function(){optCount++;var el=$('optList');el.insertAdjacentHTML('beforeend','<div style="display:flex;gap:6px;margin-bottom:6px"><span style="width:32px;height:38px;display:flex;align-items:center;justify-content:center;background:#f1f5f9;border-radius:8px;font-weight:700;font-size:12px">'+optCount+'</span><input id="opt'+optCount+'" placeholder="ë³´ê¸° '+optCount+'"></div>');};
}

// --- QUIZ SUBJECTIVE ---
function rQuizS(a){
  a.innerHTML=gHead('ì£¼ê´€ì‹','âœï¸','ì£¼ê´€ì‹')+
  '<div class="form-group mt-3"><label>ë¬¸ì œ</label><textarea id="gQ" placeholder="ë¬¸ì œ ì…ë ¥" rows="2"></textarea></div>'+
  '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="form-group"><label>ì ìˆ˜</label><input type="number" id="gP" value="10"></div><div class="form-group"><label>ì œí•œì‹œê°„(ì´ˆ)</label><input type="number" id="gT" value="60"></div></div>'+
  '<div class="form-group"><label>ì •ë‹µ (ì±„ì ìš©, ì‰¼í‘œêµ¬ë¶„)</label><input id="gA" placeholder="ì •ë‹µ1, ì •ë‹µ2"></div></div>';
  bindGameBtns(a);
}

// --- QUIZ ORDER ---
function rQuizO(a){
  a.innerHTML=gHead('ìˆœì„œ ë§ì¶”ê¸°','ğŸ”¢','ìˆœì„œë§ì¶”ê¸°')+
  '<div class="form-group mt-3"><label>ë¬¸ì œ</label><textarea id="gQ" placeholder="ë¬¸ì œ ì…ë ¥" rows="2"></textarea></div>'+
  '<div class="form-group"><label>í•­ëª© (ì¤„ë°”ê¿ˆ êµ¬ë¶„)</label><textarea id="gItems" placeholder="í•­ëª©1\ní•­ëª©2\ní•­ëª©3" rows="4"></textarea></div>'+
  '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="form-group"><label>ì ìˆ˜</label><input type="number" id="gP" value="10"></div><div class="form-group"><label>ì œí•œì‹œê°„(ì´ˆ)</label><input type="number" id="gT" value="60"></div></div></div>';
  bindGameBtns(a);
}

// --- BUZZER ---
function rBuzzer(a){
  a.innerHTML=gHead('ë¶€ì €','ğŸ””','ë¶€ì €')+'<div class="form-group mt-3"><label>ì ìˆ˜</label><input type="number" id="gP" value="10"></div><p style="font-size:13px;color:#94a3b8;margin-top:8px">ì°¸ê°€ìê°€ ë¨¼ì € ëˆ„ë¥´ë©´ ì‘ë‹µì— ìˆœì„œëŒ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p></div>';
  bindGameBtns(a);
}

// --- BUZZER COUNT ---
function rBuzzerC(a){
  a.innerHTML=gHead('ë¶€ì €ì¹´ìš´íŠ¸','âš¡','ë¶€ì €ì¹´ìš´íŠ¸')+
  '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="mt-3"><div class="form-group"><label>ëª©í‘œ í´ë¦­ ìˆ˜</label><input type="number" id="gTarget" value="100"></div><div class="form-group"><label>ëª¨ë“œ</label><select id="gMode"><option value="individual">ê°œì¸ì „</option><option value="team">íŒ€ì „</option></select></div></div></div>';
  bindGameBtns(a);
}

// --- CODE NUMBER ---
function rCodeNum(a){
  a.innerHTML=gHead('ì½”ë“œë„˜ë²„','ğŸ”²','ì½”ë“œë„˜ë²„')+
  '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="mt-3"><div class="form-group"><label>ë³´ë“œ í¬ê¸°</label><input type="number" id="gBS" value="9" min="4" max="20"></div><div class="form-group"><label>ìµœëŒ€ ìˆ«ì</label><input type="number" id="gMN" value="30"></div></div>'+
  '<div style="display:flex;gap:8px;margin-top:12px"><button class="btn btn-primary" id="cnNextBtn"><i class="ri-skip-forward-fill"></i> ë‹¤ìŒ</button><button class="btn btn-success" id="cnAutoBtn">â–¶ ìë™</button><button class="btn btn-danger" id="cnStopBtn">â–  ì •ì§€</button></div>'+
  '<div id="cnNum" class="cn-display">-</div></div>';
  bindGameBtns(a);
  $('cnNextBtn').onclick=function(){S.emit('host:code_number_next',{eventId:EID,gameId:GID});};
  $('cnAutoBtn').onclick=function(){S.emit('host:code_number_start_auto',{eventId:EID,gameId:GID});};
  $('cnStopBtn').onclick=function(){S.emit('host:code_number_stop_auto',{eventId:EID,gameId:GID});};
}

// --- BINGO ---
function rBingo(a){
  a.innerHTML=gHead('ë¹™ê³ ','ğŸ¯','ë¹™ê³ ')+
  '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="mt-3"><div class="form-group"><label>í¬ê¸°</label><input type="number" id="gBSize" value="5" min="3" max="7"></div><div class="form-group"><label>íƒ€ì…</label><select id="gBType"><option value="ìˆ«ìë¹™ê³ ">ìˆ«ìë¹™ê³ </option><option value="ë‹¨ì–´ë¹™ê³ ">ë‹¨ì–´ë¹™ê³ </option></select></div></div>'+
  '<div class="form-group"><label>ì ìˆ˜(ë¹™ê³  1ì¤„ë‹¹)</label><input type="number" id="gP" value="10"></div></div>';
  bindGameBtns(a);
}

// --- TIMER ---
function rTimer(a){
  a.innerHTML='<div class="game-form"><h3>â±ï¸ íƒ€ì´ë¨¸</h3>'+
  '<div class="status-header"><span class="badge '+(GID?'badge-success':'badge-gray')+'">'+(GID?'ì¤€ë¹„ë¨':'ë¯¸ì¤€ë¹„')+'</span>'+
  '<div class="ctrl-btns"><button class="btn btn-sm btn-primary" id="tPrepBtn"><i class="ri-add-line"></i> ì¤€ë¹„</button>'+
  '<button class="btn btn-sm btn-success" id="tStartBtn" '+(GID?'':'disabled')+'><i class="ri-play-fill"></i> ì‹œì‘</button>'+
  '<button class="btn btn-sm btn-danger" id="tEndBtn"><i class="ri-stop-fill"></i> ì¢…ë£Œ</button></div></div>'+
  '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="mt-3"><div class="form-group"><label>ì‹œê°„(ì´ˆ)</label><input type="number" id="gTL" value="60"></div><div class="form-group"><label>íƒ€ì…</label><select id="gTT"><option value="participant">ê°œë³„</option><option value="team">íŒ€</option></select></div></div>'+
  '<div id="tDisp" style="font-size:72px;font-weight:900;text-align:center;color:#5669FF;margin:16px 0;font-family:monospace">--:--</div></div>';
  $('tPrepBtn').onclick=function(){S.emit('host:prepare_timer',{eventId:EID,settings:{timeLimit:parseInt($('gTL').value)||60,timer:{type:$('gTT').value||'participant'}}});};
  $('tStartBtn').onclick=function(){S.emit('host:start_timer',{eventId:EID,timerId:GID});};
  $('tEndBtn').onclick=function(){S.emit('host:end_timer',{eventId:EID,timerId:GID});};
}

// --- LOTTERY ---
function rLottery(a){
  a.innerHTML='<div class="game-form"><h3>ğŸ í–‰ìš´ê¶Œ ì¶”ì²¨</h3>'+
  '<div class="form-group"><label>ë‹¹ì²¨ì ìˆ˜</label><input type="number" id="gWC" value="1" min="1"></div>'+
  '<button class="btn btn-primary btn-lg" style="width:100%;margin-top:12px" id="lotBtn"><i class="ri-gift-line"></i> ì¶”ì²¨í•˜ê¸°!</button>'+
  '<div id="lotRes" style="text-align:center;padding:20px;font-size:24px;font-weight:800;color:#5669FF;margin-top:12px"></div></div>';
  $('lotBtn').onclick=function(){S.emit('host:lottery_add',{eventId:EID,gameId:GID,winnerCount:parseInt($('gWC').value)||1});};
}

// --- LIKE ---
function rLike(a){
  a.innerHTML='<div class="game-form"><h3>â¤ï¸ ì¢‹ì•„ìš”</h3>'+
  '<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-sm btn-outline" id="likeDispBtn">ì¢‹ì•„ìš” í™”ë©´ í‘œì‹œ</button></div>'+
  '<div style="text-align:center;margin-top:16px"><div style="font-size:48px">â¤ï¸</div><div style="font-size:36px;font-weight:900;color:#EF4444;margin-top:8px" id="likeCnt">0</div></div></div>';
  $('likeDispBtn').onclick=function(){setDisp('ì¢‹ì•„ìš”');};
}

// --- SETTINGS ---
function rSettings(a){
  a.innerHTML='<div class="game-form"><h3><i class="ri-settings-3-line"></i> ì„¤ì •</h3>'+
  '<div class="form-group"><label>ì°¸ê°€ì í™”ë©´ ëª¨ë“œ</label><select id="dispSel"><option value="ëŒ€ê¸°">ëŒ€ê¸°</option><option value="ì ìˆ˜">ì ìˆ˜</option><option value="ê°œì¸ ì ìˆ˜">ê°œì¸ ì ìˆ˜</option><option value="íŒ€ ì ìˆ˜">íŒ€ ì ìˆ˜</option><option value="ì±„íŒ…">ì±„íŒ…</option><option value="ì¢‹ì•„ìš”">ì¢‹ì•„ìš”</option><option value="ì¶”ì²¨">ì¶”ì²¨</option><option value="íƒ€ì´ë¨¸">íƒ€ì´ë¨¸</option></select></div>'+
  '<button class="btn btn-primary" id="dispApplyBtn">ì ìš©</button>'+
  '<p style="font-size:13px;color:#94a3b8;margin-top:12px">ê´€ë¦¬ í˜ì´ì§€: <a href="/dashboard/event/'+EID+'/manage" style="color:#5669FF" target="_blank">ì´ë²¤íŠ¸ ê´€ë¦¬ â†’</a></p></div>';
  $('dispApplyBtn').onclick=function(){setDisp($('dispSel').value);};
}

// --- GAME ACTIONS ---
function prepareGame(type){
  GT=type; var s={};
  if(type==='ê°ê´€ì‹'){
    var opts=[]; for(var i=1;i<=optCount;i++){var v=$('opt'+i); if(v&&v.value) opts.push(v.value);}
    var ans=($('gA')?$('gA').value:'1').split(',').map(function(x){return parseInt(x.trim());});
    s={quiz:{question:$('gQ')?$('gQ').value:'',options:opts,answer:ans},points:parseInt($('gP')?$('gP').value:10)||10,timeLimit:parseInt($('gT')?$('gT').value:30)||30,answerCount:parseInt($('gAC')?$('gAC').value:1)||1,correctAnswers:ans};
  } else if(type==='ì£¼ê´€ì‹'){
    s={quiz:{question:$('gQ')?$('gQ').value:''},points:parseInt($('gP')?$('gP').value:10)||10,timeLimit:parseInt($('gT')?$('gT').value:60)||60};
  } else if(type==='ìˆœì„œë§ì¶”ê¸°'){
    var items=($('gItems')?$('gItems').value:'').split('\n').filter(function(x){return x.trim();});
    s={sequence:{question:$('gQ')?$('gQ').value:'',items:items},points:parseInt($('gP')?$('gP').value:10)||10,timeLimit:parseInt($('gT')?$('gT').value:60)||60};
  } else if(type==='ë¶€ì €'){
    s={points:parseInt($('gP')?$('gP').value:10)||10};
  } else if(type==='ë¶€ì €ì¹´ìš´íŠ¸'){
    s={buzzerCount:{targetClicks:parseInt($('gTarget')?$('gTarget').value:100)||100,gameMode:$('gMode')?$('gMode').value:'individual'}};
  } else if(type==='ì½”ë“œë„˜ë²„'){
    s={codeNumber:{boardSize:parseInt($('gBS')?$('gBS').value:9)||9,maxNumber:parseInt($('gMN')?$('gMN').value:30)||30}};
  } else if(type==='ë¹™ê³ '){
    s={bingo:{size:parseInt($('gBSize')?$('gBSize').value:5)||5,type:$('gBType')?$('gBType').value:'ìˆ«ìë¹™ê³ '},points:parseInt($('gP')?$('gP').value:10)||10};
  }
  S.emit('host:prepare_game',{eventId:EID,type:type,settings:s});
}
function startGame(){
  if(!GID){showToast('ë¨¼ì € ì¤€ë¹„í•˜ì„¸ìš”','error');return;}
  var s={};
  if(GT==='ê°ê´€ì‹'){
    var opts=[]; for(var i=1;i<=optCount;i++){var v=$('opt'+i); if(v&&v.value) opts.push(v.value);}
    var ans=($('gA')?$('gA').value:'1').split(',').map(function(x){return parseInt(x.trim());});
    s={quiz:{question:$('gQ')?$('gQ').value:'',options:opts,answer:ans},points:parseInt($('gP')?$('gP').value:10)||10,timeLimit:parseInt($('gT')?$('gT').value:30)||30,answerCount:parseInt($('gAC')?$('gAC').value:1)||1,correctAnswers:ans};
  } else if(GT==='ì£¼ê´€ì‹'){s={quiz:{question:$('gQ')?$('gQ').value:''},points:parseInt($('gP')?$('gP').value:10)||10,timeLimit:parseInt($('gT')?$('gT').value:60)||60};}
  else if(GT==='ìˆœì„œë§ì¶”ê¸°'){var items=($('gItems')?$('gItems').value:'').split('\n').filter(function(x){return x.trim();});s={sequence:{question:$('gQ')?$('gQ').value:'',items:items},points:parseInt($('gP')?$('gP').value:10)||10,timeLimit:parseInt($('gT')?$('gT').value:60)||60};}
  S.emit('host:start_game',{eventId:EID,gameId:GID,settings:s});
}
function endGame(){if(GID)S.emit('host:end_game',{eventId:EID,gameId:GID});}
function gradeAnswers(){
  var ans=$('gA')?$('gA').value:'';
  if(!ans){showToast('ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  var arr=ans.split(',').map(function(x){return x.trim();});
  S.emit('host:correct_answers',{eventId:EID,gameId:GID,correctAnswers:arr});
  S.emit('host:grade_answers',{eventId:EID,gameId:GID,correctAnswers:arr});
}
function awardPoints(){S.emit('host:award_points',{eventId:EID,gameId:GID});}
function setDisp(mode){S.emit('host:display_mode',{eventId:EID,displayMode:mode});}

// --- Response tracking ---
function addResp(d){
  responses.push(d);
  var div=document.createElement('div');div.className='resp-item';
  div.innerHTML='<span style="font-weight:600">'+(d.participantName||'ì°¸ê°€ì')+'</span><span style="color:#64748b">'+(typeof d.answer==='object'?JSON.stringify(d.answer):d.answer)+'</span>';
  $('RL').prepend(div);
  $('respCnt').textContent='ì‘ë‹µ '+responses.length+'ëª…';
}
function updateBC(d){
  var rl=$('RL'); var el=rl.querySelector('[data-pid="'+d.participantId+'"]');
  var pn='?'; EP.forEach(function(p){if(p.id==d.participantId)pn=p.name;});
  if(!el){el=document.createElement('div');el.className='resp-item';el.dataset.pid=d.participantId;rl.appendChild(el);}
  el.innerHTML='<span style="font-weight:600">'+pn+'</span><span style="font-weight:800;color:#5669FF">'+d.clicks+'</span>';
}
function renderRevealed(d){
  var rl=$('RL');rl.innerHTML='';
  d.responses.forEach(function(r){
    var pn='?'; EP.forEach(function(p){if(p.id==r.participantId)pn=p.name;});
    var div=document.createElement('div');div.className='resp-item';
    div.innerHTML='<span style="font-weight:600">'+pn+': '+(r.answer||'-')+'</span><span style="font-weight:700;color:'+(r.isCorrect?'#22C55E':'#EF4444')+'">'+(r.isCorrect?'âœ… +'+r.earnedPoints:'âŒ')+'</span>';
    rl.appendChild(div);
  });
  $('respCnt').textContent='ê²°ê³¼ '+d.responses.length+'ëª…';
}

// --- Chat ---
function addHChat(d){
  var el=$('HCM');if(!el)return;
  var div=document.createElement('div');div.className='chat-msg '+(d.author==='host'?'mine':'other');
  div.innerHTML='<div class="sender">'+(d.senderName||'')+'</div>'+d.message;
  el.appendChild(div);el.scrollTop=el.scrollHeight;
}

// Init
$('pCnt').textContent = EP.length;
rf();
})();
</script>
{% endblock %}
