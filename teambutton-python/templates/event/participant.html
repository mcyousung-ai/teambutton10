{% extends "base.html" %}
{% block nav %}{% endblock %}
{% block title %}{{ event.title }}{% endblock %}
{% block extra_css %}
<style>
body{background:#000;overflow-x:hidden;color:#fff}
/* Nav bar */
.pt-nav{position:sticky;top:0;z-index:50;background:rgba(0,0,0,.85);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.08);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
.pt-nav h3{font-size:15px;font-weight:700;color:#fff}
.pt-nav .score{font-size:14px;font-weight:800;color:#0ff;text-shadow:0 0 8px rgba(0,255,255,.4)}
/* Game container - matches original */
.game-container{display:flex;flex-grow:1;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 49px);padding:1.5rem;width:100%}
.game-container.dark{background:radial-gradient(circle at center,#090b0f,#000);color:#fff}
.game-container.light{background:radial-gradient(circle at center,#f8f9fa,#e9ecef);color:#000}
/* Quiz layout */
.quiz-container{position:relative;flex:1;display:flex;flex-direction:column;height:100%;width:100%;max-width:500px}
.quiz-content{flex:1;display:flex;flex-direction:column;overflow-y:auto;padding:.5rem .5rem 0}
.quiz-footer{position:sticky;bottom:0;left:0;right:0;background:#fff;padding:.75rem;border-top:1px solid var(--gray-200);z-index:10}
.quiz-footer.dark{background:rgba(0,0,0,.9);border-color:rgba(255,255,255,.1)}
.quiz-button-grid{display:grid;width:100%;gap:.5rem .25rem;overflow-y:auto}
.quiz-cube-button{position:relative;padding:16px;border-radius:14px;border:2px solid transparent;cursor:pointer;transition:all .2s;font-weight:600;min-height:60px;display:flex;align-items:center;justify-content:center;text-align:center;overflow:hidden}
.quiz-cube-button.indigo{background:linear-gradient(145deg,#4f46e5,#3730a3);color:#fff;box-shadow:0 4px 12px rgba(79,70,229,.3)}
.quiz-cube-button.indigo:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(79,70,229,.4)}
.quiz-cube-button.indigo.selected{background:linear-gradient(145deg,#f59e0b,#d97706);border-color:#fbbf24;box-shadow:0 0 20px rgba(245,158,11,.4)}
.quiz-cube-button.indigo.correct{background:linear-gradient(145deg,#22c55e,#16a34a);border-color:#86efac}
.quiz-cube-button.indigo.wrong{background:linear-gradient(145deg,#ef4444,#dc2626);border-color:#fca5a5}
/* Timer bar */
.timer-bar{position:relative;width:100%;height:20px;background:rgba(255,255,255,.1);overflow:hidden;flex-shrink:0}
.timer-bar .fill{position:absolute;top:0;left:0;height:100%;background:linear-gradient(90deg,#ef4444,#f59e0b);transition:width 1s linear}
.timer-bar .text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.5)}
/* Buzzer - original 3D */
.buzzer-wrap{position:relative;perspective:800px}
.buzzer-btn{width:200px;height:200px;border-radius:50%;border:none;cursor:pointer;position:relative;background:radial-gradient(circle at 35% 35%,#333,#111,#000);box-shadow:inset -8px -8px 16px rgba(0,0,0,.6),inset 8px 8px 16px rgba(255,255,255,.08),0 4px 8px rgba(0,255,255,.3);transition:all .15s;user-select:none;-webkit-tap-highlight-color:transparent;transform:translateZ(10px)}
.buzzer-btn:hover{box-shadow:inset -8px -8px 16px rgba(0,0,0,.6),inset 8px 8px 16px rgba(255,255,255,.1),0 6px 12px rgba(0,255,255,.4);transform:translateZ(15px)}
.buzzer-btn:active{transform:translateZ(5px);box-shadow:inset -4px -4px 8px rgba(0,0,0,.8),inset 4px 4px 8px rgba(255,255,255,.05),0 2px 4px rgba(0,0,0,.6)}
.buzzer-btn.pressed{background:radial-gradient(circle at center,#fff200,#f80 60%,#f60);box-shadow:inset -8px -8px 16px rgba(0,0,0,.3),inset 8px 8px 16px rgba(255,255,255,.3),0 0 30px rgba(255,215,0,.6);animation:activeGlow 2s infinite alternate}
.buzzer-btn .btext{position:relative;color:#0ff;font-size:2rem;font-weight:700;text-transform:uppercase;letter-spacing:2px;text-shadow:0 0 10px rgba(0,255,255,.4),0 0 20px rgba(0,255,255,.4);transition:all .3s;z-index:2}
.buzzer-btn.pressed .btext{color:#1a1a1a;text-shadow:0 0 10px rgba(255,255,255,.8)}
.led-ring{position:absolute;width:calc(100% + 20px);height:calc(100% + 20px);top:-10px;left:-10px;border-radius:50%;box-shadow:0 0 15px #0ff,0 0 30px #0ff,0 0 60px #0ff,inset 0 0 20px #0ff;animation:pulseLED 2s ease-in-out infinite;z-index:0;pointer-events:none}
.led-ring.flash{animation:flashYellow .6s forwards}
@keyframes pulseLED{0%,100%{box-shadow:0 0 15px #0ff,0 0 30px #0ff,0 0 60px #0ff,inset 0 0 20px #0ff}50%{box-shadow:0 0 25px #0ff,0 0 50px #0ff,0 0 80px #0ff,inset 0 0 30px #0ff}}
@keyframes flashYellow{0%{box-shadow:0 0 0 #ff0,inset 0 0 0 #ff0}100%{box-shadow:0 0 40px #ff0,0 0 80px #ff0,0 0 120px #ff0,inset 0 0 40px #ff0}}
@keyframes activeGlow{0%{box-shadow:0 0 20px #ff0}100%{box-shadow:0 0 40px #ff0,0 0 80px rgba(255,215,0,.5)}}
/* Buzzer Count */
.bc-progress{width:100%;background:rgba(255,255,255,.1);border-radius:6px;height:10px;overflow:hidden}
.bc-progress .fill{height:100%;border-radius:6px;background:linear-gradient(90deg,#0891b2,#0d9488);transition:width .3s}
.bc-clicks{font-size:56px;font-weight:900;color:#0ff;text-shadow:0 0 10px #0ff,0 0 20px rgba(0,255,255,.4);font-family:'Pretendard',monospace;text-align:center}
/* Bingo */
.bingo-grid{display:grid;gap:6px}
.bingo-cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:10px;font-weight:700;font-size:14px;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.08);border:2px solid rgba(255,255,255,.15);color:#fff}
.bingo-cell:hover{transform:scale(1.05);border-color:rgba(0,255,255,.4)}
.bingo-cell.selected{background:linear-gradient(135deg,#4f46e5,#7c3aed);border-color:#818cf8;box-shadow:0 0 12px rgba(99,102,241,.4)}
.bingo-cell.filled{background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.25)}
/* Code number */
.cn-board{display:grid;gap:10px}
.cn-cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:12px;font-weight:800;font-size:20px;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.06);border:3px solid rgba(255,255,255,.12);color:#fff}
.cn-cell:hover{background:rgba(79,70,229,.6);border-color:#6366f1;box-shadow:0 5px 15px rgba(79,70,229,.4);transform:translateY(-2px)}
.cn-cell.placed{background:rgba(79,70,229,.3);border-color:#818cf8;color:#c7d2fe}
.cn-current{display:flex;align-items:center;justify-content:center;padding:14px;border-radius:14px;border:1px solid rgba(0,255,255,.3);background:rgba(0,255,255,.05);flex:1}
.cn-current.active{border-color:#0ff;box-shadow:0 0 20px rgba(0,255,255,.2)}
.cn-number{font-size:48px;font-weight:900;color:#0ff;text-shadow:0 0 10px rgba(0,255,255,.4);line-height:1}
/* Timer page */
.timer-page{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 49px);padding:24px;position:relative;overflow:hidden}
.timer-blob{position:absolute;border-radius:50%;filter:blur(60px);opacity:.3;animation:blob 7s infinite}
@keyframes blob{0%,100%{border-radius:60% 40% 30% 70%/60% 30% 70% 40%}50%{border-radius:30% 60% 70% 40%/50% 60% 30% 60%}}
.timer-card{position:relative;background:rgba(255,255,255,.06);backdrop-filter:blur(12px);padding:32px;border-radius:24px;border:1px solid rgba(255,255,255,.1);text-align:center;width:100%;max-width:400px}
.timer-display{font-size:72px;font-weight:900;letter-spacing:-.04em;color:#fff;text-shadow:0 0 20px rgba(255,255,255,.3)}
/* Earn points */
.earn-box{text-align:center;border-radius:20px;background:linear-gradient(135deg,rgba(99,102,241,.9),rgba(79,70,229,.9));padding:6px;margin:12px 0}
.earn-inner{background:rgba(255,255,255,.95);border-radius:16px;padding:16px;display:flex;align-items:center;justify-content:center;gap:16px}
.earn-inner .icon{font-size:36px}
.earn-inner .pts{font-size:28px;font-weight:900;color:var(--neutral-900)}
/* Waiting screen */
.wait-wrap{padding:0;width:100%;max-width:500px;margin:0 auto}
.wait-banner{width:100%;aspect-ratio:16/10;object-fit:cover;display:block;border-radius:0}
.wait-card{margin:16px;background:rgba(255,255,255,.06);border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
.wait-card-head{background:linear-gradient(135deg,var(--point-600),#7c3aed);padding:12px 16px}
.wait-card-head h3{color:#fff;font-size:16px;display:flex;align-items:center;gap:8px}
.wait-card-body{padding:16px}
.wait-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.wait-item{background:rgba(255,255,255,.06);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,.08)}
.wait-item label{font-size:12px;color:var(--point-300);font-weight:600;display:block;margin-bottom:4px}
.wait-item .val{font-size:16px;font-weight:700;color:#fff}
/* Result card */
.result-wrap{border-radius:20px;background:linear-gradient(135deg,rgba(99,102,241,.9),rgba(79,70,229,.9));padding:6px;margin:12px;text-align:center}
.result-inner{background:rgba(255,255,255,.95);border-radius:16px;padding:16px;color:var(--neutral-900)}
/* Like float */
.float-like{position:fixed;bottom:80px;right:16px;z-index:90}
.float-like button{width:52px;height:52px;border-radius:50%;border:none;background:linear-gradient(135deg,#EF4444,#DC2626);color:#fff;font-size:22px;cursor:pointer;box-shadow:0 4px 15px rgba(239,68,68,.4);display:flex;align-items:center;justify-content:center}
.float-like button:active{transform:scale(.9)}
.like-float{position:fixed;animation:floatUp 1.5s ease forwards;pointer-events:none;z-index:9999}
@keyframes floatUp{from{opacity:1;transform:translateY(0) scale(1)}to{opacity:0;transform:translateY(-200px) scale(1.5)}}
/* Chat float */
.float-chat{position:fixed;bottom:0;left:0;right:0;z-index:90;max-width:500px;margin:0 auto}
.chat-panel{background:rgba(0,0,0,.9);backdrop-filter:blur(12px);border-top:1px solid rgba(255,255,255,.1);max-height:300px;display:flex;flex-direction:column}
.chat-panel .msgs{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:4px;max-height:220px}
</style>
{% endblock %}
{% block content %}
<div style="max-width:500px;margin:0 auto;display:flex;flex-direction:column;min-height:100vh;background:#000">
<div class="pt-nav">
<h3>{{ event.title }}</h3>
<div style="display:flex;align-items:center;gap:8px">
<span class="badge badge-gray" id="evStat">{{ event.status }}</span>
<span class="score" id="myScoreH">{{ participant.score }}P</span>
</div>
</div>
<div id="mainBody" style="flex:1;display:flex;flex-direction:column"></div>
<div class="float-like hidden" id="likeArea"><button id="likeBtn">â¤ï¸</button></div>
<div class="float-chat hidden" id="chatArea">
<div style="text-align:right;padding:4px 12px"><button class="btn btn-sm btn-outline" style="color:#fff;border-color:rgba(255,255,255,.2)" id="chatTogBtn">ğŸ’¬ ì±„íŒ…</button></div>
<div id="chatPanel" class="chat-panel hidden"><div class="msgs" id="pCM"></div><div class="chat-input" style="background:rgba(0,0,0,.9);border-color:rgba(255,255,255,.1)"><input type="text" id="pCI" placeholder="ë©”ì‹œì§€..." style="background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.15);color:#fff"><button class="btn btn-sm btn-primary" id="pCSend">ì „ì†¡</button></div></div>
</div>
</div>
<script>
var EID = {{ event.id }};
var PID = {{ participant.id }};
var PNAME = '{{ participant.name }}';
var TID = {{ participant.team_id or 'null' }};
var TNAME = '{{ participant.team_name or "" }}';
var evData = {{ event|tojson|safe }};
var allP = {{ participants|tojson|safe }};
var myScore = {{ participant.score }};
</script>
<script>
(function(){
var S=io(),body=document.getElementById('mainBody'),currentGame=null,submitted=false,selectedOpts=[],
myClicks=0,winnerData=null,cnCurrent=null,cnBoard=[],bingoBoard=[],bingoCorrect=[],bingoTurn=null,
revealData=null,lotteryWinners=[],timerTotal=0,timerRemain=0,timerInterval=null;

function $(id){return document.getElementById(id)}
S.emit('participant:join',{eventId:EID,participantId:PID});

// UI bindings
$('likeBtn').onclick=function(){S.emit('event:like',{eventId:EID,participantId:PID});var h=document.createElement('div');h.className='like-float';h.textContent='â¤ï¸';h.style.cssText='left:'+(20+Math.random()*60)+'%;bottom:100px;font-size:'+(20+Math.random()*16)+'px';document.body.appendChild(h);setTimeout(function(){h.remove()},1500)};
$('chatTogBtn').onclick=function(){$('chatPanel').classList.toggle('hidden')};
$('pCSend').onclick=function(){var v=$('pCI').value;if(!v.trim())return;S.emit('chat:send',{eventId:EID,message:v,senderId:PID,senderName:PNAME,type:'all',author:'normal'});$('pCI').value=''};
$('pCI').onkeypress=function(e){if(e.key==='Enter')$('pCSend').click()};

// Socket events
S.on('event:started',function(){evData.status='ì§„í–‰ì¤‘';$('evStat').textContent='ì§„í–‰ì¤‘';$('evStat').className='badge badge-success';render()});
S.on('event:ended',function(){evData.status='ì¢…ë£Œ';render()});
S.on('event:updated',function(d){for(var k in d)evData[k]=d[k];if(d.like_active!==undefined)$('likeArea').classList.toggle('hidden',!d.like_active);if(d.chat_active!==undefined)$('chatArea').classList.toggle('hidden',!d.chat_active);render()});
S.on('participants:updated',function(d){allP=d.participants;var me;for(var i=0;i<allP.length;i++){if(allP[i].id==PID){me=allP[i];break}}if(me){myScore=me.score;$('myScoreH').textContent=me.score+'P'}});
S.on('event:kick',function(d){if(d.participantId==PID){alert('í‡´ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');location.href='/'}});
S.on('chat:message',function(d){addChat(d)});
S.on('game:prepared',function(d){currentGame=d;submitted=false;selectedOpts=[];myClicks=0;render()});
S.on('game:started',function(d){if(currentGame){for(var k in d)currentGame[k]=d[k]}else currentGame=d;currentGame.status='ì§„í–‰ì¤‘';submitted=false;selectedOpts=[];myClicks=0;render()});
S.on('game:ended',function(){if(currentGame)currentGame.status='ì¢…ë£Œ';render()});
S.on('game:buzzer_count_click',function(d){if(d.participantId==PID){myClicks=d.clicks;renderBC()}});
S.on('game:buzzer_count_winner',function(d){winnerData=d.winner;renderBCEnd()});
S.on('game:code_number_next',function(d){cnCurrent=d.number;renderCN()});
S.on('game:bingo_turn_update',function(d){bingoCorrect=d.correctItems||[];bingoTurn=d.playerTurn;renderBingo()});
S.on('game:answers_revealed',function(d){revealData=d;renderQuizResult()});
S.on('game:lottery_result',function(d){lotteryWinners=d.winners;renderLottery()});
S.on('timer:started',function(d){timerTotal=d.timeLimit;timerRemain=d.timeLimit;renderTimerPage()});
S.on('timer:tick',function(d){timerRemain=d.remaining;updateTimerDisp()});
S.on('timer:ended',function(){timerRemain=0;updateTimerDisp()});

function render(){
if(evData.status==='ëª¨ì§‘ì¤‘'||evData.status==='ëŒ€ê¸°')return renderWait();
if(evData.status==='ì¢…ë£Œ')return body.innerHTML='<div class="game-container dark"><div style="text-align:center"><div style="font-size:48px;margin-bottom:16px">ğŸ‰</div><h2 style="font-size:24px;font-weight:800">ì´ë²¤íŠ¸ ì¢…ë£Œ</h2><p style="color:rgba(255,255,255,.6);margin-top:8px">ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤</p></div></div>';
if(evData.displayMode==='ì¶”ì²¨')return renderLottery();
if(!currentGame||currentGame.status==='ì¢…ë£Œ'){if(['í™ˆ','ëŒ€ê¸°','ì±„íŒ…','íŒ€ ì ìˆ˜','ê°œì¸ ì ìˆ˜','ì ìˆ˜'].includes(evData.displayMode))return renderWait();return renderWait()}
var t=currentGame.type;
if(t==='ê°ê´€ì‹')renderQuiz();
else if(t==='ì£¼ê´€ì‹')renderSubj();
else if(t==='ìˆœì„œë§ì¶”ê¸°')renderOrder();
else if(t==='ë¶€ì €')renderBuzzer();
else if(t==='ë¶€ì €ì¹´ìš´íŠ¸')renderBC();
else if(t==='ë¹™ê³ ')renderBingo();
else if(t==='ì½”ë“œë„˜ë²„'){if(!cnBoard.length)cnBoard=new Array(((currentGame.settings||{}).codeNumber||{}).boardSize||9).fill(null);renderCN()}
else if(t==='ì¶”ì²¨')renderLottery();
else if(t==='íƒ€ì´ë¨¸')renderTimerPage();
else body.innerHTML='<div class="game-container dark"><p>ê²Œì„ ì¤€ë¹„ ì¤‘...</p></div>';
}

function renderWait(){
body.innerHTML='<div class="wait-wrap"><img src="'+(evData.image||'/static/images/banner.png')+'" class="wait-banner" onerror="this.src=\'/static/images/banner.png\'">'+
'<div class="wait-card"><div class="wait-card-head"><h3><i class="ri-user-3-fill"></i> ë‚´ ì •ë³´</h3></div><div class="wait-card-body"><div class="wait-grid">'+
'<div class="wait-item"><label>ì´ë¦„</label><div class="val">'+PNAME+'</div></div>'+
(TNAME?'<div class="wait-item"><label>ì†Œì† íŒ€</label><div class="val">'+TNAME+'</div></div>':'')+
'<div class="wait-item"><label>ë‚´ ì ìˆ˜</label><div class="val" style="color:#0ff">'+myScore+'P</div></div>'+
'<div class="wait-item"><label>ì°¸ê°€ì</label><div class="val">'+allP.length+'ëª…</div></div></div></div></div></div>';
}

function renderQuiz(){
var g=currentGame,s=g.settings||{},opts=(s.quiz||{}).options||[];
var isWait=g.status==='ëŒ€ê¸°ì¤‘';
var h='<div style="display:flex;flex-direction:column;height:100%;width:100%;max-width:500px;margin:0 auto">';
if(!isWait&&s.timeLimit)h+='<div class="timer-bar"><div class="fill" id="tFill" style="width:100%"></div><div class="text" id="tText">'+s.timeLimit+'ì´ˆ</div></div>';
h+='<div style="flex:1;overflow-y:auto;padding:8px">';
if(isWait)h+='<div class="game-container dark"><h2 style="font-size:22px;font-weight:700">ê²Œì„ ì¤€ë¹„ ì™„ë£Œ</h2><p style="color:rgba(255,255,255,.6);margin-top:8px">ì‹œì‘ë˜ë©´ ì •ë‹µì„ ì„ íƒí•˜ì„¸ìš”</p></div>';
else{
if((s.quiz||{}).question)h+='<div style="background:rgba(255,255,255,.06);padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,.08);margin-bottom:12px"><div style="font-size:12px;font-weight:600;color:var(--point-300);margin-bottom:4px">ğŸ“ ë¬¸ì œ</div><p style="font-size:15px;font-weight:500">'+s.quiz.question+'</p></div>';
if(s.answerCount>1)h+='<div style="background:rgba(245,158,11,.15);color:#fbbf24;font-size:13px;font-weight:600;padding:8px;border-radius:8px;text-align:center;margin-bottom:12px">ì •ë‹µ ìµœëŒ€ '+s.answerCount+'ê°œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!</div>';
var cols=opts.length<=3?1:(opts.length<=6?2:3);
h+='<div class="quiz-button-grid" style="grid-template-columns:repeat('+cols+',1fr)">';
for(var i=0;i<opts.length;i++){
h+='<button class="quiz-cube-button indigo" data-idx="'+(i+1)+'" id="qopt'+(i+1)+'"><div style="display:flex;flex-direction:column;align-items:center;gap:4px"><span style="font-size:16px;font-weight:700">'+(i+1)+'</span>'+(opts[i]?'<span style="font-size:13px">'+opts[i]+'</span>':'')+'</div></button>';
}
h+='</div><div id="qSub"></div>';
}
h+='</div>';
if(!isWait)h+='<div class="quiz-footer dark"><button class="btn btn-primary btn-lg" style="width:100%" id="qSubmitBtn" disabled>ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”</button></div>';
h+='</div>';
body.innerHTML=h;
if(!isWait){
for(var j=0;j<opts.length;j++){(function(idx){
var btn=$('qopt'+idx);if(btn)btn.onclick=function(){selectQuiz(idx)};
})(j+1)}
var sb=$('qSubmitBtn');if(sb)sb.onclick=submitQuiz;
if(s.timeLimit)startTimer(s.timeLimit);
}
}
function selectQuiz(idx){
if(submitted)return;
var max=(currentGame.settings||{}).answerCount||1;
var si=String(idx);
var pos=selectedOpts.indexOf(si);
if(pos>=0)selectedOpts.splice(pos,1);
else{if(selectedOpts.length>=max)selectedOpts.splice(0,1);selectedOpts.push(si)}
for(var i=1;i<=((currentGame.settings||{}).quiz||{}).options.length;i++){
var b=$('qopt'+i);if(b){b.classList.toggle('selected',selectedOpts.indexOf(String(i))>=0)}
}
var btn=$('qSubmitBtn');if(btn){btn.disabled=!selectedOpts.length;btn.textContent=selectedOpts.length?selectedOpts.join(', ')+'ë²ˆ ì œì¶œí•˜ê¸°':'ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”'}
}
function submitQuiz(){
if(!selectedOpts.length||submitted)return;submitted=true;
S.emit('game:submit_answer',{gameId:currentGame.gameId||currentGame.id,participantId:PID,answer:selectedOpts});
showToast('ë‹µë³€ ì œì¶œ ì™„ë£Œ!');
var btn=$('qSubmitBtn');if(btn){btn.disabled=true;btn.textContent='"'+selectedOpts.join(', ')+'ë²ˆ" ì œì¶œ ì™„ë£Œ'}
var sub=$('qSub');if(sub)sub.innerHTML='<div style="text-align:center;background:rgba(99,102,241,.15);border-radius:14px;padding:14px;margin-top:12px;border:1px solid rgba(99,102,241,.2)"><p style="font-size:14px;font-weight:600;color:#a5b4fc">ì œì¶œ ì™„ë£Œ Â· ë§ˆê° ì „ ë³€ê²½ ê°€ëŠ¥</p></div>';
}

function renderSubj(){
var g=currentGame,s=g.settings||{},isWait=g.status==='ëŒ€ê¸°ì¤‘';
var h='<div style="display:flex;flex-direction:column;height:100%;width:100%;max-width:500px;margin:0 auto">';
if(!isWait&&s.timeLimit)h+='<div class="timer-bar"><div class="fill" id="tFill" style="width:100%"></div><div class="text" id="tText">'+s.timeLimit+'ì´ˆ</div></div>';
h+='<div class="game-container dark">';
if(isWait)h+='<h2 style="font-size:22px;font-weight:700">ê²Œì„ ì¤€ë¹„ ì™„ë£Œ</h2><p style="color:rgba(255,255,255,.6);margin-top:8px">ì‹œì‘ë˜ë©´ ë‹µì„ ì…ë ¥í•˜ì„¸ìš”</p>';
else{
if((s.quiz||{}).question)h+='<div style="background:rgba(255,255,255,.06);padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,.08);margin-bottom:16px"><div style="font-size:12px;font-weight:600;color:var(--point-300);margin-bottom:4px">ğŸ“ ë¬¸ì œ</div><p style="font-size:15px;font-weight:500">'+s.quiz.question+'</p></div>';
h+='<div style="width:100%;max-width:400px"><input type="text" id="subjIn" placeholder="ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”" style="text-align:center;font-size:16px;padding:14px;border-radius:14px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);color:#fff"></div>';
h+='<button class="btn btn-primary btn-lg" style="width:100%;max-width:400px;margin-top:12px" id="subjBtn">ì œì¶œí•˜ê¸°</button>';
}
h+='</div></div>';
body.innerHTML=h;
if(!isWait){
var sb=$('subjBtn');if(sb)sb.onclick=function(){var v=$('subjIn').value;if(!v)return;submitted=true;S.emit('game:submit_answer',{gameId:currentGame.gameId||currentGame.id,participantId:PID,answer:v});showToast('ì œì¶œ ì™„ë£Œ!')};
if(s.timeLimit)startTimer(s.timeLimit);
}
}

function renderOrder(){renderSubj()}

function renderBuzzer(){
var g=currentGame;
body.innerHTML='<div class="game-container dark"><div class="buzzer-wrap"><div class="led-ring'+(submitted?' flash':'')+'"></div><button class="buzzer-btn'+(submitted?' pressed':'')+'" id="buzBtn"'+(submitted?' disabled':'')+'><span class="btext">'+(submitted?'STOP':'START')+'</span></button></div>'+(submitted?'<div style="margin-top:24px;text-align:center"><p style="font-size:18px;font-weight:700;color:#ff0">ğŸ”” BUZZ!</p></div>':'')+'</div>';
var bb=$('buzBtn');if(bb&&!submitted)bb.onclick=function(){submitted=true;S.emit('game:submit_answer',{gameId:g.gameId||g.id,participantId:PID,answer:'buzz',timestamp:new Date().toISOString()});renderBuzzer()};
}

function renderBC(){
var g=currentGame,s=g.settings||{},target=((s.buzzerCount)||{}).targetClicks||100,pct=Math.min(100,myClicks/target*100);
var isWait=g.status==='ëŒ€ê¸°ì¤‘';
body.innerHTML='<div class="game-container dark">'+(isWait?
'<div style="text-align:center"><div style="font-size:48px;margin-bottom:16px">â³</div><h2 style="font-size:22px;font-weight:700">ì ì‹œ í›„ ì‹œì‘</h2><p style="color:rgba(255,255,255,.6);margin-top:8px">ëª©í‘œ '+target.toLocaleString()+' í´ë¦­</p></div>':
'<div style="width:100%;max-width:400px;text-align:center">'+
'<div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px"><span style="color:rgba(255,255,255,.6)">ì§„í–‰ë¥ </span><span style="color:#0ff;font-weight:700">'+pct.toFixed(1)+'%</span></div>'+
'<div class="bc-progress"><div class="fill" style="width:'+pct+'%"></div></div>'+
'<div style="font-size:12px;color:rgba(255,255,255,.4);margin-bottom:16px">'+myClicks.toLocaleString()+' / '+target.toLocaleString()+'</div>'+
'<div class="buzzer-wrap"><div class="led-ring'+(myClicks>=target?' flash':'')+'"></div><button class="buzzer-btn'+(myClicks>=target?' pressed':'')+'" id="bcBtn"'+(myClicks>=target?' disabled':'')+'><span class="btext">'+(myClicks>=target?'DONE':'CLICK')+'</span></button></div>'+
'<div class="bc-clicks" style="margin-top:16px">'+myClicks.toLocaleString()+'</div>'+
'<div style="font-size:14px;color:#0aa;font-family:monospace;text-shadow:0 0 5px #0ff">CLICKS</div></div>')+'</div>';
var bb=$('bcBtn');if(bb&&myClicks<target)bb.onclick=function(){myClicks++;S.emit('game:buzzer_count_click',{gameId:g.gameId||g.id,participantId:PID,eventId:EID});renderBC()};
}
function renderBCEnd(){body.innerHTML='<div class="game-container dark"><div style="text-align:center"><div style="font-size:48px;margin-bottom:12px">ğŸ†</div><h2 style="font-size:24px;font-weight:800;color:#fff">ê²Œì„ ì¢…ë£Œ</h2><p style="color:rgba(255,255,255,.6);margin-top:8px">ìµœì¢… í´ë¦­: '+myClicks.toLocaleString()+'</p></div></div>'}

function renderBingo(){
var g=currentGame,s=g.settings||{},size=((s.bingo)||{}).size||5;
if(!bingoBoard.length)bingoBoard=new Array(size*size).fill('');
var h='<div style="padding:16px;width:100%;max-width:500px;margin:0 auto"><div class="bingo-grid" style="grid-template-columns:repeat('+size+',1fr)">';
for(var i=0;i<bingoBoard.length;i++){
var c=bingoBoard[i],isSel=bingoCorrect.indexOf(c)>=0;
h+='<div class="bingo-cell'+(isSel?' selected':c?' filled':'')+'" data-bi="'+i+'">'+(((s.bingo||{}).type==='ìˆ«ìë¹™ê³ ')?(i+1):c||'')+'</div>';
}
h+='</div></div>';
body.innerHTML=h;
body.querySelectorAll('.bingo-cell').forEach(function(el){el.onclick=function(){
var idx=parseInt(this.dataset.bi);if(!currentGame||currentGame.status!=='ì§„í–‰ì¤‘')return;
var w=bingoBoard[idx]||prompt('ë‹¨ì–´:');if(!w)return;bingoBoard[idx]=w;
S.emit('game:bingo_turn',{gameId:currentGame.gameId||currentGame.id,participantId:PID,answer:w});renderBingo()
}});
}

function renderCN(){
var g=currentGame,s=g.settings||{},bs=((s.codeNumber)||{}).boardSize||9,cols=Math.ceil(Math.sqrt(bs));
var hasNum=cnCurrent!==null,placed=false;for(var i=0;i<cnBoard.length;i++)if(cnBoard[i]===cnCurrent){placed=true;break}
var h='<div style="padding:16px;width:100%;max-width:500px;margin:0 auto">'+
(g.status==='ëŒ€ê¸°ì¤‘'?'<div class="game-container dark"><p style="font-size:18px;font-weight:700">ê³§ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤</p></div>':
'<div style="display:flex;gap:12px;margin-bottom:12px">'+
'<div class="cn-current'+(hasNum&&!placed?' active':'')+'"><div><div style="font-size:12px;font-weight:600;color:'+(hasNum?'#a5b4fc':'rgba(255,255,255,.4)')+';margin-bottom:4px">'+(placed?'ìœ„ì¹˜ ì¡°ì • ê°€ëŠ¥':'í˜„ì¬ ìˆ«ì')+'</div><div class="cn-number">'+(cnCurrent===0?'ğŸƒ':(cnCurrent||'?'))+'</div></div></div>'+
'<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)"><div style="font-size:12px;font-weight:600;color:rgba(255,255,255,.4);margin-bottom:4px">ë‚´ í¬ì¸íŠ¸</div><div style="font-size:36px;font-weight:900;color:#0ff" id="cnScore">0</div></div></div>'+
'<div class="cn-board" style="grid-template-columns:repeat('+cols+',1fr)">'+
(function(){var o='';for(var j=0;j<cnBoard.length;j++){o+='<div class="cn-cell'+(cnBoard[j]!==null?' placed':'')+'" data-ci="'+j+'">'+(cnBoard[j]===0?'ğŸƒ':(cnBoard[j]||''))+'</div>'}return o})()+
'</div>')+'</div>';
body.innerHTML=h;
body.querySelectorAll('.cn-cell').forEach(function(el){el.onclick=function(){
var pos=parseInt(this.dataset.ci);if(!currentGame||cnCurrent===null)return;
if(cnBoard[pos]!==null&&cnBoard[pos]!==cnCurrent)return;
var prev=-1;for(var i=0;i<cnBoard.length;i++)if(cnBoard[i]===cnCurrent){prev=i;break}
if(prev!==-1)cnBoard[prev]=null;cnBoard[pos]=cnCurrent;
S.emit('game:code_number_place',{gameId:currentGame.gameId||currentGame.id,participantId:PID,position:pos,eventId:EID});renderCN()
}});
}

function renderQuizResult(){
var me=null;if(revealData&&revealData.responses)for(var i=0;i<revealData.responses.length;i++)if(revealData.responses[i].participantId==PID){me=revealData.responses[i];break}
var h='<div class="game-container dark"><div style="width:100%;max-width:400px">';
if(me&&me.earnedPoints)h+='<div class="earn-box"><div class="earn-inner"><span class="icon">ğŸ†</span><span class="pts">+'+me.earnedPoints+'ì </span></div></div>';
h+='<div class="result-wrap"><div class="result-inner">';
if(me){
h+='<div style="display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;background:'+(me.isCorrect?'#f0fdf4':'#fef2f2')+';border:1px solid '+(me.isCorrect?'#bbf7d0':'#fecaca')+';color:'+(me.isCorrect?'#16a34a':'#dc2626')+';font-weight:600;margin-bottom:12px">'+(me.isCorrect?'âœ… ì •ë‹µì…ë‹ˆë‹¤!':'âŒ ì˜¤ë‹µì…ë‹ˆë‹¤')+'</div>';
if(!me.isCorrect&&revealData.correctAnswers){
var ca=Array.isArray(revealData.correctAnswers)?revealData.correctAnswers.join(', '):revealData.correctAnswers;
h+='<div style="padding:10px;background:#f8fafc;border-radius:8px"><p style="font-size:14px;font-weight:600">ì •ë‹µ: '+ca+'</p></div>';
}
}else h+='<div style="padding:10px;background:#f8fafc;border-radius:8px;color:var(--gray-500)">ë‹µë³€ì„ ì œì¶œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>';
h+='</div></div></div></div>';
body.innerHTML=h;
}

function renderLottery(){
body.innerHTML='<div class="game-container dark"><div style="text-align:center;width:100%;max-width:400px"><h2 style="font-size:22px;font-weight:700;margin-bottom:16px">ğŸ° í–‰ìš´ê¶Œ ì¶”ì²¨</h2>'+
(lotteryWinners.length?'<div style="padding:24px;background:linear-gradient(135deg,rgba(99,102,241,.15),rgba(124,58,237,.15));border-radius:20px;border:1px solid rgba(99,102,241,.3)"><div style="font-size:48px;margin-bottom:12px">ğŸ†</div><p style="font-size:22px;font-weight:700;color:#a5b4fc">'+lotteryWinners.join(', ')+'</p></div>':'<p style="color:rgba(255,255,255,.6)">ì¶”ì²¨ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...</p>')+'</div></div>';
}

function renderTimerPage(){
body.innerHTML='<div class="timer-page"><div class="timer-blob" style="width:250px;height:250px;background:#818cf8;top:-40px;left:-60px"></div><div class="timer-blob" style="width:250px;height:250px;background:#22d3ee;top:-40px;right:-60px;animation-delay:2s"></div><div class="timer-blob" style="width:250px;height:250px;background:#a78bfa;bottom:-40px;left:80px;animation-delay:4s"></div>'+
'<div class="timer-card"><div class="badge badge-primary" style="margin-bottom:12px">íƒ€ì´ë¨¸</div><div class="timer-display" id="tDisp">--:--</div><div style="color:rgba(255,255,255,.5);font-size:16px;margin-top:8px">'+PNAME+'</div></div></div>';
updateTimerDisp();
}
function updateTimerDisp(){var el=$('tDisp');if(!el)return;var m=Math.floor(timerRemain/60),s=timerRemain%60;el.textContent=m+':'+String(s).padStart(2,'0');el.style.color=timerRemain<=10?'#ef4444':'#fff'}

function startTimer(limit){
clearInterval(timerInterval);var remain=limit;
timerInterval=setInterval(function(){remain--;var f=$('tFill'),t=$('tText');if(f)f.style.width=(remain/limit*100)+'%';if(t)t.textContent=remain+'ì´ˆ';if(remain<=0)clearInterval(timerInterval)},1000);
}

function addChat(d){var el=$('pCM');if(!el)return;var div=document.createElement('div');div.className='chat-msg '+(d.senderId==PID?'mine':'other');div.innerHTML='<div class="sender">'+(d.senderName||'')+'</div>'+d.message;el.appendChild(div);el.scrollTop=el.scrollHeight}

// Init
S.emit('game:get_current',{eventId:EID});
S.on('game:current',function(d){if(d&&d.status!=='ì¢…ë£Œ'){currentGame=d;render()}else render()});
render();
})();
</script>
{% endblock %}
