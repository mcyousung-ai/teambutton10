{% extends "base.html" %}
{% block nav %}{% endblock %}
{% block title %}{{ event.title }}{% endblock %}
{% block content %}
<div style="max-width:500px;margin:0 auto;padding:16px;min-height:100vh">
<div class="text-center mb-4"><h2>{{ event.title }}</h2><p class="text-muted">{{ participant.name }} {% if participant.team_name %}({{ participant.team_name }}){% endif %}</p><span class="badge badge-gray" id="evStatus">{{ event.status }}</span><div class="mt-2 text-sm">ë‚´ ì ìˆ˜: <strong class="text-primary" style="font-size:20px" id="myScore">{{ participant.score }}</strong></div></div>
<!-- Game Area -->
<div id="gameArea"><div class="card text-center"><p class="text-muted">ê²Œì„ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p></div></div>
<!-- Like -->
<div id="likeArea" class="{% if not event.like_active %}hidden{% endif %}" style="position:fixed;bottom:80px;right:20px"><button class="btn btn-danger" onclick="doLike()" style="border-radius:50%;width:56px;height:56px;font-size:24px">â¤ï¸</button></div>
<!-- Chat -->
<div id="chatArea" class="{% if not event.chat_active %}hidden{% endif %}" style="position:fixed;bottom:0;left:0;right:0;max-width:500px;margin:0 auto">
<div id="chatToggleBtn" style="text-align:right;padding:4px 16px"><button class="btn btn-sm btn-outline" onclick="toggleChat()">ğŸ’¬ ì±„íŒ…</button></div>
<div id="chatPanel" class="hidden" style="background:var(--bg2);border-top:1px solid var(--border)">
<div id="pChatMsgs" style="height:200px;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:4px"></div>
<div class="chat-input"><input type="text" id="pChatIn" placeholder="ë©”ì‹œì§€..." onkeypress="if(event.key==='Enter')pSendChat()"><button class="btn btn-sm btn-primary" onclick="pSendChat()">ì „ì†¡</button></div>
</div>
</div>
</div>
<script>
const E={{ event.id }},PID={{ participant.id }},PNAME='{{ participant.name }}',TID={{ participant.team_id or 'null' }};
const S=io();S.emit('participant:join',{eventId:E,participantId:PID});
let currentGame=null;

S.on('event:started',()=>{$('evStatus').textContent='ì§„í–‰ì¤‘';$('evStatus').className='badge badge-success';});
S.on('event:ended',()=>{$('evStatus').textContent='ì¢…ë£Œ';$('evStatus').className='badge badge-danger';$('gameArea').innerHTML='<div class="card text-center"><h2>ì´ë²¤íŠ¸ ì¢…ë£Œ</h2></div>';});
S.on('event:updated',d=>{if(d.like_active!==undefined)$('likeArea').classList.toggle('hidden',!d.like_active);if(d.chat_active!==undefined)$('chatArea').classList.toggle('hidden',!d.chat_active);});
S.on('event:like_updated',d=>{});
S.on('event:kick',d=>{if(d.participantId==PID){alert('í˜¸ìŠ¤íŠ¸ì— ì˜í•´ í‡´ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');location.href='/';}});
S.on('participants:updated',d=>{const me=d.participants.find(p=>p.id==PID);if(me)$('myScore').textContent=me.score;});
S.on('chat:message',d=>addPChat(d));

// Game events
S.on('game:prepared',d=>{currentGame=d;showGameUI(d);});
S.on('game:started',d=>{currentGame=d;showGameUI(d);});
S.on('game:ended',d=>{currentGame=null;$('gameArea').innerHTML='<div class="card text-center"><h2>'+d.type+' ì¢…ë£Œ!</h2></div>';});
S.on('game:buzzer_count_click',d=>{if(d.participantId==PID){const el=$('myClicks');if(el)el.textContent=d.clicks;}});
S.on('game:buzzer_count_winner',d=>{$('gameArea').innerHTML='<div class="card text-center"><h2>ğŸ† ìš°ìŠ¹!</h2><p style="font-size:24px;font-weight:700;color:var(--primary-light)">'+d.winner.name+'</p><p>'+d.winner.clicks+' í´ë¦­</p></div>';});
S.on('game:code_number_next',d=>{const el=$('cnNumber');if(el)el.textContent=d.number;currentNumber=d.number;});
S.on('game:bingo_turn_update',d=>{correctItems=d.correctItems||[];updateBingoBoard();const el=$('bingoTurn');if(el)el.textContent=d.playerTurn==PID?'ğŸŸ¢ ë‚´ ì°¨ë¡€!':'ìƒëŒ€ ì°¨ë¡€';});
S.on('game:answers_revealed',d=>{const r=d.responses.find(x=>x.participantId==PID);if(r){$('gameArea').innerHTML='<div class="card text-center"><h2>'+(r.isCorrect?'âœ… ì •ë‹µ!':'âŒ ì˜¤ë‹µ')+'</h2>'+(r.isCorrect?'<p class="text-success" style="font-size:24px;font-weight:700">+'+r.earnedPoints+'ì </p>':'')+'</div>';}});
S.on('game:lottery_result',d=>{$('gameArea').innerHTML='<div class="card text-center"><h2>ğŸ‰ ì¶”ì²¨ ê²°ê³¼</h2><p style="font-size:24px;font-weight:700;color:var(--primary-light)">'+d.winners.join(', ')+'</p></div>';});
S.on('timer:started',d=>{showTimer(d.timeLimit);});
S.on('timer:tick',d=>{const el=$('timerVal');if(el){const m=Math.floor(d.remaining/60),s=d.remaining%60;el.textContent=m+':'+String(s).padStart(2,'0');if(d.remaining<=10)el.style.color='var(--danger)';}});
S.on('timer:ended',()=>{const el=$('timerVal');if(el)el.textContent='ì¢…ë£Œ!';});

function $(id){return document.getElementById(id)}
let correctItems=[],bingoBoard=[],currentNumber=null;

function showGameUI(d){
const t=d.type,s=d.settings||{};let h='';
if(t==='í€´ì¦ˆ'){
h='<div class="card"><h3>'+(s.quiz?.question||'ë¬¸ì œ')+'</h3><div class="mt-4">';
(s.quiz?.options||[]).forEach((o,i)=>{h+='<div class="quiz-option" data-i="'+i+'" onclick="selectOption(this,'+i+')"><span style="width:24px;height:24px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0">'+(i+1)+'</span><span>'+o+'</span></div>';});
h+='</div><button class="btn btn-primary btn-block mt-4" onclick="submitQuiz()">ì œì¶œ</button></div>';
} else if(t==='ì£¼ê´€ì‹í€´ì¦ˆ'){
h='<div class="card"><h3>'+(s.quiz?.question||'ë¬¸ì œ')+'</h3><textarea id="subjAnswer" class="mt-4" placeholder="ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"></textarea><button class="btn btn-primary btn-block mt-2" onclick="submitSubj()">ì œì¶œ</button></div>';
} else if(t==='ë¶€ì €'){
h='<div class="card text-center"><h3>ë¶€ì €</h3><button class="buzzer-btn mt-4" onclick="submitBuzzer()">BUZZ!</button></div>';
} else if(t==='ë¶€ì €ì¹´ìš´íŠ¸'){
h='<div class="card text-center"><h3>ë¶€ì €ì¹´ìš´íŠ¸</h3><p class="text-muted">ëª©í‘œ: '+(s.buzzerCount?.targetClicks||100)+' í´ë¦­</p><div id="myClicks" style="font-size:48px;font-weight:800;color:var(--primary-light);margin:16px 0">0</div><button class="buzzer-btn" onclick="buzzerClick()" style="width:180px;height:180px;font-size:36px">CLICK!</button></div>';
} else if(t==='ë¹™ê³ '){
const size=s.bingo?.size||5;bingoBoard=[];
h='<div class="card"><h3>ë¹™ê³  <span id="bingoTurn" class="text-sm text-muted"></span></h3><div class="bingo-grid mt-4" id="bingoGrid" style="grid-template-columns:repeat('+size+',1fr)">';
for(let i=0;i<size*size;i++){bingoBoard.push(s.bingo?.type==='ìˆ«ìë¹™ê³ '?(i+1).toString():'');h+='<div class="bingo-cell" data-i="'+i+'" onclick="bingoClick('+i+')">'+(s.bingo?.type==='ìˆ«ìë¹™ê³ '?(i+1):'')+'</div>';}
h+='</div></div>';
} else if(t==='ì½”ë“œë„˜ë²„'){
const bs=s.codeNumber?.boardSize||9;
h='<div class="card"><h3>ì½”ë“œë„˜ë²„</h3><div id="cnNumber" style="font-size:48px;font-weight:800;text-align:center;color:var(--primary-light);margin:8px 0">-</div><div class="code-number-board mt-2" id="cnBoard" style="grid-template-columns:repeat('+Math.ceil(Math.sqrt(bs))+',1fr)">';
for(let i=0;i<bs;i++)h+='<div class="code-number-cell" data-i="'+i+'" onclick="cnPlace('+i+')"></div>';
h+='</div></div>';
} else if(t==='ì¶”ì²¨'){
h='<div class="card text-center"><h2>ğŸ ì¶”ì²¨</h2><p class="text-muted mt-2">ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p></div>';
} else if(t==='íƒ€ì´ë¨¸'){
showTimer(s.timeLimit||60);return;
} else {
h='<div class="card text-center"><h3>'+t+'</h3><p class="text-muted">ê²Œì„ ì§„í–‰ ì¤‘...</p></div>';
}
$('gameArea').innerHTML=h;
}

function showTimer(tl){$('gameArea').innerHTML='<div class="card text-center"><h3>â±ï¸ íƒ€ì´ë¨¸</h3><div id="timerVal" style="font-size:72px;font-weight:800;color:var(--primary-light);margin:16px 0">'+Math.floor(tl/60)+':'+String(tl%60).padStart(2,'0')+'</div></div>';}

let selectedOption=null;
function selectOption(el,i){document.querySelectorAll('.quiz-option').forEach(e=>e.classList.remove('selected'));el.classList.add('selected');selectedOption=i;}
function submitQuiz(){if(selectedOption===null)return showToast('ë³´ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”','error');S.emit('game:submit_answer',{gameId:currentGame.gameId,participantId:PID,answer:selectedOption});showToast('ì œì¶œ ì™„ë£Œ!');$('gameArea').innerHTML='<div class="card text-center"><h2>âœ… ì œì¶œ ì™„ë£Œ</h2><p class="text-muted">ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p></div>';}
function submitSubj(){const a=$('subjAnswer')?.value;if(!a)return;S.emit('game:submit_answer',{gameId:currentGame.gameId,participantId:PID,answer:a});showToast('ì œì¶œ ì™„ë£Œ!');$('gameArea').innerHTML='<div class="card text-center"><h2>âœ… ì œì¶œ ì™„ë£Œ</h2></div>';}
function submitBuzzer(){S.emit('game:submit_answer',{gameId:currentGame.gameId,participantId:PID,answer:'buzz',timestamp:new Date().toISOString()});showToast('BUZZ!');$('gameArea').innerHTML='<div class="card text-center"><h2>ğŸ”” BUZZ!</h2></div>';}
function buzzerClick(){S.emit('game:buzzer_count_click',{gameId:currentGame.gameId,participantId:PID,eventId:E});}
function bingoClick(i){if(!currentGame)return;const word=bingoBoard[i]||prompt('ë‹¨ì–´:');if(!word)return;bingoBoard[i]=word;S.emit('game:bingo_turn',{gameId:currentGame.gameId,participantId:PID,answer:word});updateBingoBoard();}
function updateBingoBoard(){document.querySelectorAll('.bingo-cell').forEach((el,i)=>{el.textContent=bingoBoard[i]||'';el.classList.toggle('correct',correctItems.includes(bingoBoard[i]));});}
function cnPlace(pos){if(!currentGame)return;S.emit('game:code_number_place',{gameId:currentGame.gameId,participantId:PID,position:pos,eventId:E});const el=document.querySelectorAll('.code-number-cell')[pos];if(el&&currentNumber){el.textContent=currentNumber;el.classList.add('filled');}}

// Like
function doLike(){S.emit('event:like',{eventId:E,participantId:PID});const h=document.createElement('div');h.className='like-float';h.textContent='â¤ï¸';h.style.cssText='left:'+Math.random()*80+'%;bottom:100px;font-size:24px;';document.body.appendChild(h);setTimeout(()=>h.remove(),1500);}

// Chat
function toggleChat(){$('chatPanel').classList.toggle('hidden');}
function pSendChat(){const i=$('pChatIn');if(!i.value.trim())return;S.emit('chat:send',{eventId:E,message:i.value,senderId:PID,senderName:PNAME,type:'all',author:'normal',anonymous:false});i.value='';}
function addPChat(d){const el=$('pChatMsgs');if(!el)return;const div=document.createElement('div');div.className='chat-msg '+(d.senderId==PID?'mine':'other');div.innerHTML='<div class="sender">'+(d.senderName||'')+'</div>'+d.message;el.appendChild(div);el.scrollTop=el.scrollHeight;}

// Request current game state
S.emit('game:get_current',{eventId:E});
S.on('game:current',d=>{if(d&&d.status==='ì§„í–‰ì¤‘'){currentGame=d;showGameUI(d);}});
</script>
{% endblock %}
